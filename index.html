<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>臨床病史失智診斷結構性問卷 - 互動式評估工具</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: "Microsoft JhengHei", "微軟正黑體", Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 14px;
            opacity: 0.9;
        }

        .progress-bar {
            background: #e5e7eb;
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
            margin: 20px 30px;
        }

        .progress-fill {
            background: linear-gradient(90deg, #3b82f6, #1e40af);
            height: 100%;
            width: 0%;
            transition: width 0.3s ease;
        }

        .progress-text {
            text-align: center;
            color: #6b7280;
            font-size: 14px;
            margin-top: 10px;
        }

        .content {
            padding: 30px;
        }

        .section-title {
            font-size: 22px;
            font-weight: bold;
            color: #1e40af;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 3px solid #dbeafe;
        }

        .section-subtitle {
            color: #6b7280;
            font-size: 14px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-weight: 600;
            color: #374151;
            margin-bottom: 8px;
        }

        .form-label .required {
            color: #dc2626;
        }

        .form-input, .form-select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: #3b82f6;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .question-item {
            padding: 20px;
            background: #f9fafb;
            border-radius: 10px;
            margin-bottom: 15px;
            border-left: 4px solid #3b82f6;
        }

        .question-header {
            display: flex;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .question-number {
            background: #3b82f6;
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 14px;
            margin-right: 12px;
            flex-shrink: 0;
        }

        .question-text {
            font-weight: 500;
            color: #1f2937;
            flex: 1;
        }

        .question-note {
            font-size: 13px;
            color: #6b7280;
            margin: 8px 0 0 44px;
            font-style: italic;
        }

        .radio-group {
            display: flex;
            gap: 20px;
            margin-left: 44px;
            flex-wrap: wrap;
        }

        .radio-group.vertical {
            flex-direction: column;
            gap: 10px;
        }

        .radio-label {
            display: flex;
            align-items: center;
            cursor: pointer;
            padding: 8px 16px;
            border-radius: 8px;
            transition: background-color 0.2s;
        }

        .radio-label:hover {
            background: #e0e7ff;
        }

        .radio-label input[type="radio"] {
            margin-right: 8px;
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .button-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 30px;
        }

        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #3b82f6, #1e40af);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(59, 130, 246, 0.4);
        }

        .btn-secondary {
            background: #6b7280;
            color: white;
        }

        .btn-secondary:hover {
            background: #4b5563;
        }

        .btn-success {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(16, 185, 129, 0.4);
        }

        .info-box {
            background: #dbeafe;
            border-left: 4px solid #3b82f6;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 25px;
        }

        .info-box h3 {
            color: #1e40af;
            margin-bottom: 10px;
            font-size: 18px;
        }

        .info-box ul {
            list-style-position: inside;
            color: #374151;
        }

        .info-box li {
            margin-bottom: 5px;
            padding-left: 10px;
        }

        .results-container {
            padding: 30px;
        }

        .risk-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            border-left: 5px solid #3b82f6;
        }

        .risk-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .risk-item {
            text-align: center;
            padding: 20px;
            background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
            border-radius: 10px;
        }

        .risk-label {
            font-size: 14px;
            color: #6b7280;
            margin-bottom: 8px;
        }

        .risk-value {
            font-size: 32px;
            font-weight: bold;
        }

        .risk-high { color: #dc2626; }
        .risk-moderate { color: #ea580c; }
        .risk-mild { color: #ca8a04; }
        .risk-low { color: #16a34a; }

        .probability-bars {
            margin: 20px 0;
        }

        .probability-item {
            margin-bottom: 20px;
        }

        .probability-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .probability-name {
            font-weight: 600;
            color: #374151;
        }

        .probability-percent {
            font-weight: bold;
            color: #3b82f6;
            font-size: 18px;
        }

        .probability-bar {
            width: 100%;
            height: 30px;
            background: #e5e7eb;
            border-radius: 15px;
            overflow: hidden;
            position: relative;
        }

        .probability-fill {
            height: 100%;
            background: linear-gradient(90deg, #3b82f6, #1e40af);
            border-radius: 15px;
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 12px;
            color: white;
            font-weight: bold;
            font-size: 14px;
        }

        .recommendations {
            margin: 20px 0;
        }

        .recommendation-item {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 12px;
            border-left: 4px solid;
        }

        .rec-urgent {
            background: #fef2f2;
            border-color: #dc2626;
        }

        .rec-important {
            background: #fff7ed;
            border-color: #ea580c;
        }

        .rec-clinical {
            background: #eff6ff;
            border-color: #3b82f6;
        }

        .rec-safety {
            background: #f0fdf4;
            border-color: #16a34a;
        }

        .rec-title {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .disclaimer {
            background: #fef3c7;
            border: 2px solid #f59e0b;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }

        .disclaimer h3 {
            color: #92400e;
            margin-bottom: 10px;
        }

        .disclaimer ul {
            list-style-position: inside;
            color: #78350f;
        }

        .disclaimer li {
            margin-bottom: 5px;
        }

        .symptoms-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background: white;
            border-radius: 8px;
            overflow: hidden;
        }

        .symptoms-table th {
            background: #f3f4f6;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: #374151;
            border-bottom: 2px solid #e5e7eb;
        }

        .symptoms-table td {
            padding: 12px;
            border-bottom: 1px solid #e5e7eb;
            color: #4b5563;
        }

        .symptoms-table tr:last-child td {
            border-bottom: none;
        }

        .symptom-positive {
            color: #dc2626;
            font-weight: 600;
        }

        .hidden {
            display: none;
        }

        @media print {
            body {
                background: white;
                padding: 0;
            }
            .container {
                box-shadow: none;
            }
            .btn {
                display: none;
            }
        }

        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
            }
            .radio-group {
                flex-direction: column;
            }
            .button-group {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>📋 臨床病史失智診斷結構性問卷</h1>
            <p>Interactive Assessment Tool - 互動式評估工具</p>
        </div>

        <div class="progress-bar" id="progressBar">
            <div class="progress-fill" id="progressFill"></div>
        </div>
        <div class="progress-text" id="progressText"></div>

        <!-- 步驟0: 基本資料 -->
        <div id="step0" class="content">
            <div class="info-box">
                <h3>📌 評估說明</h3>
                <ul>
                    <li>本問卷用於初步評估失智症風險，不能取代專業醫療診斷</li>
                    <li>請由了解患者狀況的家屬或照顧者協助填寫</li>
                    <li>評估約需15-20分鐘，請依實際情況誠實作答</li>
                    <li>所有資料將嚴格保密，僅供臨床參考</li>
                    <li>完成後可下載完整文字報告或匯出資料供分析</li>
                    <li><strong>✨ 填答過程中可隨時返回修改，完成後也能回到任何步驟重新調整</strong></li>
                </ul>
            </div>

        <div class="info-box" style="background: #fff7ed; border-left-color: #f59e0b;">
                <h3>💡 檔案自動儲存設定</h3>
                <ul>
                    <li><strong>Chrome/Edge</strong>：設定 → 下載 → 設定預設下載位置（不勾選「下載前詢問」）</li>
                    <li><strong>Firefox</strong>：設定 → 一般 → 檔案與應用程式 → 選擇「儲存檔案至」並設定資料夾</li>
                    <li><strong>Safari</strong>：偏好設定 → 一般 → 檔案下載位置</li>
                    <li>設定完成後，報告會自動下載到您指定的資料夾，完成後自動返回首頁</li>
                </ul>
            </div>

            <!-- 加入這個新的 info-box -->
            <div class="info-box" style="background: #e0f2fe; border-left-color: #0ea5e9;">
                <h3>☁️ 雲端儲存功能</h3>
                <ul>
                    <li>評估完成後可選擇「上傳到雲端」自動儲存</li>
                    <li>所有上傳的資料會自動整合成 Excel 報表</li>
                </ul>
            </div>

            <div class="section-title">👤 基本資料</div>
            <div class="form-grid">
                <div class="form-group">
                    <label class="form-label">病患姓名 <span class="required">*</span></label>
                    <input type="text" id="patientName" class="form-input" placeholder="請輸入姓名">
                </div>
                <div class="form-group">
                    <label class="form-label">病歷號 <span class="required">*</span></label>
                    <input type="text" id="chartNumber" class="form-input" placeholder="請輸入病歷號">
                </div>
                <div class="form-group">
                    <label class="form-label">出生日期 <span class="required">*</span></label>
                    <input type="date" id="birthDate" class="form-input">
                </div>
                <div class="form-group">
                    <label class="form-label">性別 <span class="required">*</span></label>
                    <select id="gender" class="form-select">
                        <option value="">請選擇</option>
                        <option value="男">男</option>
                        <option value="女">女</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">教育程度</label>
                    <select id="education" class="form-select">
                        <option value="">請選擇</option>
                        <option value="不識字">不識字</option>
                        <option value="小學">小學</option>
                        <option value="國中">國中</option>
                        <option value="高中職">高中職</option>
                        <option value="專科">專科</option>
                        <option value="大學">大學</option>
                        <option value="研究所以上">研究所以上</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">評估日期</label>
                    <input type="date" id="assessmentDate" class="form-input">
                </div>
                <div class="form-group">
                    <label class="form-label">資訊提供者姓名 <span class="required">*</span></label>
                    <input type="text" id="informantName" class="form-input" placeholder="填寫者姓名">
                </div>
                <div class="form-group">
                    <label class="form-label">與患者關係 <span class="required">*</span></label>
                    <input type="text" id="informantRelation" class="form-input" placeholder="例如：配偶、子女、照顧者">
                </div>
            </div>

            <div class="button-group">
                <button class="btn btn-primary" onclick="startAssessment()">
                    開始評估 →
                </button>
            </div>
        </div>

        <!-- 問卷步驟 -->
        <div id="questionSteps" class="content hidden"></div>

        <!-- 結果頁面 -->
        <div id="resultsPage" class="content hidden"></div>
    </div>

    <script>
        // 全局變數
        let currentStep = 0;
        let responses = {};
        let patientInfo = {};

        // 問卷結構
        const questionSections = [
            {
                id: 'consciousness',
                title: '一、意識或睡眠症狀',
                subtitle: '(不清楚或是不確定請選否)',
                questions: [
                    { id: 'dlb1_1', text: '白天嗜睡或經常昏昏欲睡', type: 'yesno' },
                    { id: 'dlb1_2', text: '常常思緒雜亂無章，說話不合邏輯', type: 'yesno' },
                    { id: 'dlb1_3', text: '意識或認知症狀起伏很大，甚至一天之內好壞就差很多嗎？', type: 'noyes' },
                    { id: 'dlb1_4', text: '睡覺時因為夢境而產生一些動作行為，例如：喊叫、揮拳、揮舞雙臂、起身跑等', type: 'yesno' }
                ]
            },
            {
                id: 'motor',
                title: '二、動作障礙症狀',
                subtitle: '(不清楚或是不確定請選否)',
                questions: [
                    { id: 'dlb2_1', text: '坐著或靜止不動的時候，肢體或頭部會明顯地顫抖', type: 'yesno' },
                    { id: 'dlb2_2', text: '動作變得緩慢，尤其是起步特別困難，面部表情也明顯減少', type: 'yesno' },
                    { id: 'dlb2_3', text: '動作變得僵硬，走路步伐變小身體會前傾', type: 'yesno' },
                    { id: 'dlb2_4', text: '動作變得不穩，走路不平衡，有時候好像要跌倒或真的跌倒', type: 'yesno' }
                ]
            },
            {
                id: 'behavioral',
                title: '三、情緒行為症狀',
                subtitle: '(不清楚或是不確定請選否)',
                questions: [
                    { id: 'dlb3_1', text: '有視幻覺，會「清楚」地看見別人看不到的人、動物或其他物體', type: 'yesno', note: '(註：只像是過去的片段記憶不算；只對空氣講話不算；半夢半醒或是視力不佳看到的黑影或錯覺也不算)' },
                    { id: 'dlb3_2', text: '變得多疑或妄想，常常有一些與事實不符的想法，例如：錢財被偷或人被傷害', type: 'yesno' },
                    { id: 'dlb3_3', text: '變得情緒低落、憂鬱、有負面想法，或是倦怠乏力', type: 'yesno' },
                    { id: 'ftd3_4', text: '變得躁動，情緒不容易控制，甚至會用言語或動作傷害別人', type: 'yesno' },
                    { id: 'ftd3_5', text: '變得冷漠，對周邊的事物失去動力或興趣', type: 'yesno' },
                    { id: 'ftd3_6', text: '變得缺乏同理心，毫不在意外界的想法與感受，也不會同情別人', type: 'yesno' },
                    { id: 'ftd3_7', text: '產生怪異行為、重複的動作，或是強迫性的言語或行為', type: 'yesno' },
                    { id: 'ftd3_8', text: '飲食喜好改變，或更酗菸或酒，不正常地吃甜食，或將不可吃的東西放入口裡', type: 'yesno' }
                ]
            },
            {
                id: 'autonomic',
                title: '四、自律神經症狀',
                subtitle: '(不清楚或是不確定請選否)',
                questions: [
                    { id: 'vad4_1', text: '經常有排尿問題', type: 'yesno' },
                    { id: 'dlb4_2', text: '經常頭暈，尤其是在變換姿勢的時候', type: 'yesno' },
                    { id: 'dlb4_3', text: '曾有短暫意識喪失', type: 'yesno' }
                ]
            },
            {
                id: 'memory',
                title: '五、記憶力症狀',
                subtitle: '(不清楚或是不確定請選不會)',
                questions: [
                    { id: 'ad5_1', text: '會忘記熟悉親人或朋友的名字嗎？', type: 'noyes' },
                    { id: 'ad5_2', text: '會重複問相同的問題或講相同的事情嗎？', type: 'noyes' },
                    { id: 'ad5_3', text: '會忘記與別人的重要約會嗎？', type: 'noyes' },
                    { id: 'ad5_4', text: '學習如何使用新的工具設備（例如：手機或其他電子產品）會變得困難嗎？', type: 'noyes' },
                    { id: 'ad5_5', text: '會常常忘記物品放置位置嗎？', type: 'frequency3' },
                    { id: 'ad5_6', text: '會常常忘記最近發生的事情嗎？', type: 'frequency3' },
                    { id: 'ad5_7', text: '會常常忘記關瓦斯或水龍頭嗎？', type: 'frequency3' },
                    { id: 'ad5_8', text: '會因為回答不出問題或是分不清楚過去現在，就亂編故事嗎？', type: 'frequency3' }
                ]
            },
            {
                id: 'orientation',
                title: '六、定向力症狀',
                subtitle: '(不清楚或是不確定請選不會)',
                questions: [
                    { id: 'ad6_1', text: '會忘記正確的年份和月份嗎？', type: 'noyes' },
                    { id: 'ad6_2', text: '在熟悉的環境（例如：住家附近）會迷路嗎？', type: 'noyes' },
                    { id: 'ad6_3', text: '尋找物品（例如：找冰箱或櫃子內物品）會有困難嗎？', type: 'noyes' },
                    { id: 'ad6_4', text: '會無法辨認親人臉孔、自家建築房間或自己的物品嗎？', type: 'noyes' },
                    { id: 'ad6_5', text: '空間認知（例如：停車有困難或身處危險地方不自知）有變差嗎？', type: 'noyes' }
                ]
            },
            {
                id: 'executive',
                title: '七、判斷力與執行功能症狀',
                subtitle: '(不清楚或是不確定請選不會)',
                questions: [
                    { id: 'ftd7_1', text: '應對進退（例如：參加親朋好友婚喪喜慶）會有不適當言行舉止嗎？', type: 'noyes' },
                    { id: 'vad7_2', text: '做出錯誤的判斷或決定嗎？例如：被騙、買不適宜物品、不顧安危等', type: 'noyes' },
                    { id: 'vad7_3', text: '處理複雜的財務，例如：上銀行、繳費、開支票等會變得困難嗎？', type: 'noyes' },
                    { id: 'vad7_4', text: '變得很困難計畫安排或下決定嗎？', type: 'decision' },
                    { id: 'vad7_5', text: '變得不知事情的輕重緩急（重要性），搞錯順序嗎？', type: 'noyes' },
                    { id: 'vad7_6', text: '操作日常生活用品明顯比以前困難嗎？例如：使用電話、遙控器，或微波爐等', type: 'noyes' },
                    { id: 'vad7_7', text: '面對問題變得無法解決或思考變得沒有彈性不知變通嗎？', type: 'noyes' }
                ]
            },
            {
                id: 'language',
                title: '八、語言功能症狀',
                subtitle: '(不清楚或是不確定請選否或不會)',
                questions: [
                    { id: 'ppa8_1', text: '想要講某個名詞例如人名或物名卻常常講不出來嗎？', type: 'frequency3' },
                    { id: 'ppa8_2', text: '說話會變得很少或變得不流利，無法完整地講一個句子嗎？', type: 'noyes' },
                    { id: 'ppa8_3', text: '說話變得容易說錯話或文法錯誤？', type: 'noyes' },
                    { id: 'ppa8_4', text: '會變得聽不懂別人的話或無法理解文意嗎？', type: 'noyes' },
                    { id: 'ppa8_5', text: '會一直重複說同樣的字句或重複別人的字句嗎？', type: 'noyes' },
                    { id: 'ftd8_6', text: '語言功能異常是否最早發生，而且比其他認知症狀早很多嗎？', type: 'yesno' }
                ]
            },
            {
                id: 'adl',
                title: '九、日常生活狀況',
                subtitle: '(請照顧者務必依病患現階段能力選擇其中一個項目)',
                questions: [
                    { id: 'adl9_1', text: '能上街購物嗎？', type: 'adl3', options: ['能獨立購買生活用品', '需要有人陪同或協助', '完全不會購買'] },
                    { id: 'adl9_2', text: '能夠自行外出活動嗎？', type: 'adl3', options: ['能獨立搭車或騎/開車', '需要有人陪同', '完全不能出門'] },
                    { id: 'adl9_3', text: '能夠準備飯菜嗎？例如作菜、點菜或外燴', type: 'adl4', options: ['不適用(平常沒在做)', '正常(可以獨立完成)', '部分自理(需要協助或只能做簡單的)', '無法自理(需要別人煮好、擺好)'] },
                    { id: 'adl9_4', text: '能夠做家事嗎？例如收拾房間、打掃', type: 'adl4', options: ['不適用(平常沒在做)', '正常(可以獨立完成)', '部分自理(只能做簡單家事)', '無法自理(完全需要別人協助)'] },
                    { id: 'adl9_5', text: '能夠洗衣服嗎？', type: 'adl4', options: ['不適用(平常沒在做)', '正常(可以獨立完成)', '部分自理(只能洗小件衣物)', '無法自理(完全依靠別人)'] },
                    { id: 'adl9_6', text: '能夠使用電話或手機嗎？', type: 'adl3', options: ['正常使用', '只會接聽或撥熟悉號碼', '完全不會使用'] },
                    { id: 'adl9_7', text: '還能夠自行服用藥物嗎？', type: 'adl3', options: ['正常或不需服藥', '需要提醒才會服用', '需要別人準備或完全依賴'] },
                    { id: 'adl9_8', text: '能夠處理錢財嗎？', type: 'adl3', options: ['能處理日常購買及財務', '只能處理簡單的零錢交易', '完全無法處理錢財'] },
                    { id: 'adl9_9', text: '現在還在從事例行的活動或平常的嗜好興趣嗎？例如運動、唸佛、上教堂、打牌、麻將、唱歌、或與孫子女玩等', type: 'adl3', options: ['如常', '有減少', '幾乎沒有或完全沒有，整天在自己房間'] },
                    { id: 'adl9_10', text: '上述活動困難，病人是因肢體或行動不便嗎？', type: 'yesno' }
                ]
            }
        ];

        // 評分權重
        const scoringWeights = {
            DLB: {
                'dlb1_1': 2.0, 'dlb1_2': 2.0, 'dlb1_3': 3.0, 'dlb1_4': 4.5,
                'dlb2_1': 3.0, 'dlb2_2': 3.5, 'dlb2_3': 3.0, 'dlb2_4': 2.5,
                'dlb3_1': 5.0, 'dlb4_2': 2.0, 'dlb4_3': 2.0
            },
            AD: {
                'ad5_1': 3.5, 'ad5_2': 4.0, 'ad5_3': 3.5, 'ad5_4': 3.0,
                'ad5_5': 2.5, 'ad5_6': 4.0, 'ad5_7': 3.0, 'ad5_8': 2.5,
                'ad6_1': 3.5, 'ad6_2': 3.0, 'ad6_3': 2.5, 'ad6_4': 3.0, 'ad6_5': 2.5,
                'dlb3_2': 1.5, 'dlb3_3': 1.5
            },
            VaD: {
                'vad7_2': 3.5, 'vad7_3': 3.5, 'vad7_4': 3.0, 'vad7_5': 3.0,
                'vad7_6': 2.5, 'vad7_7': 3.0, 'vad4_1': 2.5,
                'dlb2_4': 2.0, 'ad5_1': 1.5, 'ad5_2': 2.0, 'ad5_6': 2.0
            },
            FTD: {
                'ftd7_1': 4.0, 'ftd3_5': 4.0, 'ftd3_6': 4.5, 'ftd3_7': 3.5,
                'ftd3_8': 3.5, 'ftd3_4': 2.5, 'vad7_2': 3.0, 'vad7_4': 3.0,
                'vad7_7': 3.0, 'ftd8_6': 4.0
            },
            PPA: {
                'ppa8_1': 3.5, 'ppa8_2': 3.5, 'ppa8_3': 3.0,
                'ppa8_4': 3.5, 'ppa8_5': 3.0, 'ftd8_6': 5.0
            }
        };

        // 初始化日期
        document.getElementById('assessmentDate').valueAsDate = new Date();

        // 開始評估
        function startAssessment() {
            const name = document.getElementById('patientName').value.trim();
            const chartNumber = document.getElementById('chartNumber').value.trim();
            const birthDate = document.getElementById('birthDate').value;
            const gender = document.getElementById('gender').value;
            const informantName = document.getElementById('informantName').value.trim();
            const informantRelation = document.getElementById('informantRelation').value.trim();

            if (!name || !chartNumber || !birthDate || !gender || !informantName || !informantRelation) {
                alert('請填寫所有必填欄位（標註 * 者）');
                return;
            }

            patientInfo = {
                name: name,
                chartNumber: chartNumber,
                birthDate: birthDate,
                gender: gender,
                education: document.getElementById('education').value,
                assessmentDate: document.getElementById('assessmentDate').value,
                informantName: informantName,
                informantRelation: informantRelation
            };

            currentStep = 1;
            showStep(currentStep);
        }

        // 顯示步驟
        function showStep(step) {
            document.getElementById('step0').classList.add('hidden');
            document.getElementById('questionSteps').classList.remove('hidden');
            document.getElementById('resultsPage').classList.add('hidden');

            const section = questionSections[step - 1];
            let html = '<div class="section-title">' + section.title + '</div>';
            html += '<div class="section-subtitle">' + section.subtitle + '</div>';

            section.questions.forEach(function(q, idx) {
                html += '<div class="question-item">';
                html += '<div class="question-header">';
                html += '<span class="question-number">Q' + (idx + 1) + '</span>';
                html += '<span class="question-text">' + q.text + '</span>';
                html += '</div>';
                if (q.note) {
                    html += '<div class="question-note">' + q.note + '</div>';
                }
                html += renderQuestionInput(q);
                html += '</div>';
            });

            html += '<div class="button-group">';
            html += '<button class="btn btn-secondary" onclick="previousStep()">← 上一步</button>';
            if (step < questionSections.length) {
                html += '<button class="btn btn-primary" onclick="nextStep()">下一步 →</button>';
            } else {
                html += '<button class="btn btn-success" onclick="showResults()">✓ 完成評估</button>';
            }
            html += '</div>';

            document.getElementById('questionSteps').innerHTML = html;
            updateProgress();
            window.scrollTo(0, 0);
        }

        // 渲染問題輸入
        function renderQuestionInput(question) {
            const savedValue = responses[question.id];
            let html = '';
            
            switch(question.type) {
                case 'yesno':
                    html = '<div class="radio-group">';
                    html += '<label class="radio-label">';
                    html += '<input type="radio" name="' + question.id + '" value="否" ' + (savedValue === '否' ? 'checked' : '') + ' onchange="saveResponse(\'' + question.id + '\', \'否\')"> 否';
                    html += '</label>';
                    html += '<label class="radio-label">';
                    html += '<input type="radio" name="' + question.id + '" value="是" ' + (savedValue === '是' ? 'checked' : '') + ' onchange="saveResponse(\'' + question.id + '\', \'是\')"> 是';
                    html += '</label>';
                    html += '</div>';
                    break;
                
                case 'noyes':
                    html = '<div class="radio-group">';
                    html += '<label class="radio-label">';
                    html += '<input type="radio" name="' + question.id + '" value="不會" ' + (savedValue === '不會' ? 'checked' : '') + ' onchange="saveResponse(\'' + question.id + '\', \'不會\')"> 不會';
                    html += '</label>';
                    html += '<label class="radio-label">';
                    html += '<input type="radio" name="' + question.id + '" value="會" ' + (savedValue === '會' ? 'checked' : '') + ' onchange="saveResponse(\'' + question.id + '\', \'會\')"> 會';
                    html += '</label>';
                    html += '</div>';
                    break;
                
                case 'frequency3':
                    html = '<div class="radio-group">';
                    html += '<label class="radio-label">';
                    html += '<input type="radio" name="' + question.id + '" value="不會" ' + (savedValue === '不會' ? 'checked' : '') + ' onchange="saveResponse(\'' + question.id + '\', \'不會\')"> 不會';
                    html += '</label>';
                    html += '<label class="radio-label">';
                    html += '<input type="radio" name="' + question.id + '" value="偶爾" ' + (savedValue === '偶爾' ? 'checked' : '') + ' onchange="saveResponse(\'' + question.id + '\', \'偶爾\')"> 偶爾';
                    html += '</label>';
                    html += '<label class="radio-label">';
                    html += '<input type="radio" name="' + question.id + '" value="常常" ' + (savedValue === '常常' ? 'checked' : '') + ' onchange="saveResponse(\'' + question.id + '\', \'常常\')"> 常常';
                    html += '</label>';
                    html += '</div>';
                    break;
                
                case 'decision':
                    html = '<div class="radio-group vertical">';
                    html += '<label class="radio-label">';
                    html += '<input type="radio" name="' + question.id + '" value="不會" ' + (savedValue === '不會' ? 'checked' : '') + ' onchange="saveResponse(\'' + question.id + '\', \'不會\')"> 不會，大都是自己決定';
                    html += '</label>';
                    html += '<label class="radio-label">';
                    html += '<input type="radio" name="' + question.id + '" value="會" ' + (savedValue === '會' ? 'checked' : '') + ' onchange="saveResponse(\'' + question.id + '\', \'會\')"> 會，大都由別人幫忙決定';
                    html += '</label>';
                    html += '</div>';
                    break;
                
                case 'adl3':
                case 'adl4':
                    html = '<div class="radio-group vertical">';
                    question.options.forEach(function(opt, idx) {
                        html += '<label class="radio-label">';
                        html += '<input type="radio" name="' + question.id + '" value="' + idx + '" ' + (savedValue == idx ? 'checked' : '') + ' onchange="saveResponse(\'' + question.id + '\', ' + idx + ')"> ' + opt;
                        html += '</label>';
                    });
                    html += '</div>';
                    break;
            }
            
            return html;
        }

        // 儲存回應
        function saveResponse(questionId, value) {
            responses[questionId] = value;
        }

        // 下一步
        function nextStep() {
            if (currentStep < questionSections.length) {
                currentStep++;
                showStep(currentStep);
            }
        }

        // 上一步
        function previousStep() {
            if (currentStep > 1) {
                currentStep--;
                showStep(currentStep);
            } else {
                document.getElementById('step0').classList.remove('hidden');
                document.getElementById('questionSteps').classList.add('hidden');
                currentStep = 0;
                updateProgress();
            }
        }

        // 更新進度條
        function updateProgress() {
            const progress = (currentStep / questionSections.length) * 100;
            document.getElementById('progressFill').style.width = progress + '%';
            document.getElementById('progressText').textContent = 
                currentStep === 0 ? '準備開始' : 
                '第 ' + currentStep + ' 部分，共 ' + questionSections.length + ' 部分 (' + Math.round(progress) + '% 完成)';
        }

        // 計算評分
        function calculateScores() {
            const scores = { DLB: 0, AD: 0, VaD: 0, FTD: 0, PPA: 0 };
            const maxScores = { DLB: 0, AD: 0, VaD: 0, FTD: 0, PPA: 0 };

            Object.keys(responses).forEach(function(qId) {
                const value = responses[qId];
                
                Object.keys(scoringWeights).forEach(function(type) {
                    if (scoringWeights[type][qId]) {
                        const weight = scoringWeights[type][qId];
                        maxScores[type] += weight;
                        
                        if (value === '是' || value === '會') {
                            scores[type] += weight;
                        } else if (value === '偶爾') {
                            scores[type] += weight * 0.5;
                        } else if (value === '常常') {
                            scores[type] += weight * 1.0;
                        } else if (typeof value === 'number' && value > 0) {
                            scores[type] += weight;
                        }
                    }
                });
            });

            const adlImpairment = calculateADLImpairment();
            const functionalMultiplier = 1 + (adlImpairment / 100);
            Object.keys(scores).forEach(function(type) {
                scores[type] *= functionalMultiplier;
            });

            if (responses['dlb1_4'] === '是' && responses['dlb3_1'] === '是' && responses['dlb1_3'] === '會') {
                scores.DLB *= 1.5;
            }
            
            if (responses['ftd7_1'] === '會' && responses['ftd3_5'] === '是' && responses['ftd3_6'] === '是') {
                scores.FTD *= 1.4;
            }
            
            if (responses['ftd8_6'] === '是' && 
                (responses['ppa8_1'] === '常常' || responses['ppa8_2'] === '會' || responses['ppa8_4'] === '會')) {
                scores.PPA *= 1.5;
            }

            const percentages = {};
            Object.keys(scores).forEach(function(type) {
                percentages[type] = maxScores[type] > 0 ? 
                    Math.min(100, (scores[type] / maxScores[type]) * 100) : 0;
            });

            const totalScore = Object.values(percentages).reduce(function(a, b) { return a + b; }, 0);
            const probabilities = {};
            Object.keys(percentages).forEach(function(type) {
                probabilities[type] = totalScore > 0 ? (percentages[type] / totalScore) * 100 : 0;
            });

            return {
                rawScores: scores,
                percentages: percentages,
                probabilities: probabilities,
                adlImpairment: adlImpairment,
                overallRisk: calculateOverallRisk(percentages)
            };
        }

        // 計算ADL障礙
        function calculateADLImpairment() {
            let impairmentScore = 0;
            let totalItems = 0;
            
            for (let i = 1; i <= 9; i++) {
                const qId = 'adl9_' + i;
                if (responses[qId] !== undefined) {
                    const value = responses[qId];
                    
                    if (typeof value === 'number') {
                        if (qId === 'adl9_3' || qId === 'adl9_4' || qId === 'adl9_5') {
                            if (value === 0) {
                                continue;
                            } else {
                                totalItems++;
                                if (value === 1) {
                                    impairmentScore += 0;
                                } else if (value === 2) {
                                    impairmentScore += 0.5;
                                } else if (value === 3) {
                                    impairmentScore += 1.0;
                                }
                            }
                        } else {
                            totalItems++;
                            if (value === 0) {
                                impairmentScore += 0;
                            } else if (value === 1) {
                                impairmentScore += 0.5;
                            } else if (value >= 2) {
                                impairmentScore += 1.0;
                            }
                        }
                    }
                }
            }
            
            return totalItems > 0 ? (impairmentScore / totalItems) * 100 : 0;
        }

        // 計算整體風險
        function calculateOverallRisk(percentages) {
            const maxScore = Math.max.apply(null, Object.values(percentages));
            const avgScore = Object.values(percentages).reduce(function(a, b) { return a + b; }, 0) / 5;
            
            if (maxScore >= 60 && avgScore >= 30) return 'high';
            if (maxScore >= 40 || avgScore >= 20) return 'moderate';
            if (maxScore >= 20 || avgScore >= 10) return 'mild';
            return 'low';
        }

        // 生成建議
        function generateRecommendations(results) {
            const probabilities = results.probabilities;
            const overallRisk = results.overallRisk;
            const adlImpairment = results.adlImpairment;
            const recommendations = [];
            
            const sorted = Object.entries(probabilities)
                .sort(function(a, b) { return b[1] - a[1]; })
                .filter(function(item) { return item[1] > 15; });

            if (overallRisk === 'high') {
                recommendations.push({
                    type: 'urgent',
                    text: '建議盡快（2週內）安排神經內科或老年精神科專科醫師評估'
                });
            } else if (overallRisk === 'moderate') {
                recommendations.push({
                    type: 'important',
                    text: '建議於1個月內至記憶門診或神經科接受完整評估'
                });
            }

            if (adlImpairment > 50) {
                recommendations.push({
                    type: 'important',
                    text: '日常功能明顯受損，建議評估照護需求與安全措施'
                });
            }

            if (probabilities.DLB > 30) {
                recommendations.push({
                    type: 'clinical',
                    text: '症狀符合Lewy Body失智症特徵，建議進行DaTscan或MIBG心肌閃爍攝影檢查'
                });
                if (responses['dlb1_4'] === '是') {
                    recommendations.push({
                        type: 'safety',
                        text: '有REM睡眠行為障礙，注意睡眠安全，避免床邊放置危險物品'
                    });
                }
            }

            if (probabilities.AD > 30 && responses['ad5_2'] === '會') {
                recommendations.push({
                    type: 'clinical',
                    text: '記憶障礙顯著，建議考慮腦部MRI及血液生物標記(如plasma p-tau217)檢測'
                });
            }

            if (probabilities.FTD > 30) {
                const age = calculateAge(patientInfo.birthDate);
                if (age && age < 65) {
                    recommendations.push({
                        type: 'clinical',
                        text: '年輕發病且有明顯行為改變，建議基因檢測評估遺傳性額顳葉失智症'
                    });
                }
            }

            if (probabilities.PPA > 30) {
                recommendations.push({
                    type: 'clinical',
                    text: '語言功能障礙為主要症狀，建議語言治療評估及PET影像檢查'
                });
            }

            return { sorted: sorted, recommendations: recommendations };
        }

        // 計算年齡
        function calculateAge(birthDate) {
            if (!birthDate) return null;
            const birth = new Date(birthDate);
            const today = new Date();
            let age = today.getFullYear() - birth.getFullYear();
            const monthDiff = today.getMonth() - birth.getMonth();
            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
                age--;
            }
            return age;
        }

        // 獲取異常症狀
        function getAbnormalSymptoms() {
            const abnormalSymptoms = [];
            
            questionSections.forEach(function(section) {
                section.questions.forEach(function(q) {
                    const value = responses[q.id];
                    let isAbnormal = false;
                    
                    if (value === '是' || value === '會' || value === '常常') {
                        isAbnormal = true;
                    } else if (typeof value === 'number' && value > 0) {
                        if (q.type === 'adl4') {
                            isAbnormal = (value === 3);
                        } else if (q.type === 'adl3') {
                            isAbnormal = (value === 2);
                        } else {
                            isAbnormal = true;
                        }
                    }
                    
                    if (isAbnormal) {
                        let responseText = value;
                        if (q.type === 'adl3' || q.type === 'adl4') {
                            responseText = q.options[value] || value;
                        }
                        
                        abnormalSymptoms.push({
                            section: section.title,
                            question: q.text,
                            response: responseText
                        });
                    }
                });
            });
            
            return abnormalSymptoms;
        }

        // 失智症名稱
        function getDementiaName(type) {
            const names = {
                'AD': "Alzheimer's Disease (阿茲海默症)",
                'DLB': 'Dementia with Lewy Bodies (路易氏體失智症)',
                'VaD': 'Vascular Dementia (血管性失智症)',
                'FTD': 'Frontotemporal Dementia (額顳葉失智症)',
                'PPA': 'Primary Progressive Aphasia (原發性進行性失語症)'
            };
            return names[type] || type;
        }

        // 風險文字和顏色
        function getRiskInfo(risk) {
            const info = {
                'high': { text: '高度風險', color: 'risk-high' },
                'moderate': { text: '中度風險', color: 'risk-moderate' },
                'mild': { text: '輕度風險', color: 'risk-mild' },
                'low': { text: '低風險', color: 'risk-low' }
            };
            return info[risk] || info['low'];
        }

        // 顯示結果
        function showResults() {
            const results = calculateScores();
            const recsData = generateRecommendations(results);
            const sorted = recsData.sorted;
            const recommendations = recsData.recommendations;
            const abnormalSymptoms = getAbnormalSymptoms();
            const riskInfo = getRiskInfo(results.overallRisk);

            let html = '<div class="results-container">';
            html += '<div class="section-title">📊 評估結果報告</div>';
            
            html += '<div class="risk-card">';
            html += '<h3 style="margin-bottom: 15px;">整體評估摘要</h3>';
            html += '<div class="risk-summary">';
            html += '<div class="risk-item">';
            html += '<div class="risk-label">整體認知障礙風險等級</div>';
            html += '<div class="risk-value ' + riskInfo.color + '">' + riskInfo.text + '</div>';
            html += '</div>';
            html += '<div class="risk-item">';
            html += '<div class="risk-label">日常功能障礙程度</div>';
            html += '<div class="risk-value" style="color: #8b5cf6;">' + results.adlImpairment.toFixed(1) + '%</div>';
            html += '</div>';
            html += '</div>';
            html += '</div>';

            html += '<div class="risk-card">';
            html += '<h3 style="margin-bottom: 15px;">各類型失智症相對機率分析</h3>';
            html += '<div class="probability-bars">';

            sorted.forEach(function(item) {
                const type = item[0];
                const prob = item[1];
                html += '<div class="probability-item">';
                html += '<div class="probability-header">';
                html += '<span class="probability-name">' + getDementiaName(type) + '</span>';
                html += '<span class="probability-percent">' + prob.toFixed(1) + '%</span>';
                html += '</div>';
                html += '<div class="probability-bar">';
                html += '<div class="probability-fill" style="width: ' + prob + '%;">';
                html += (prob > 10 ? prob.toFixed(1) + '%' : '');
                html += '</div>';
                html += '</div>';
                html += '</div>';
            });

            html += '</div>';
            html += '</div>';

            html += '<div class="risk-card">';
            html += '<h3 style="margin-bottom: 15px;">🩺 臨床建議</h3>';
            html += '<div class="recommendations">';

            recommendations.forEach(function(rec) {
                const recClass = rec.type === 'urgent' ? 'rec-urgent' :
                                rec.type === 'important' ? 'rec-important' :
                                rec.type === 'clinical' ? 'rec-clinical' : 'rec-safety';
                const icon = rec.type === 'urgent' ? '⚠️' :
                            rec.type === 'important' ? '▶️' :
                            rec.type === 'clinical' ? '📋' : '🛡️';
                
                html += '<div class="recommendation-item ' + recClass + '">';
                html += '<div class="rec-title">' + icon + ' ';
                html += (rec.type === 'urgent' ? '重要' :
                         rec.type === 'important' ? '建議' :
                         rec.type === 'clinical' ? '臨床檢查' : '安全提醒');
                html += '</div>';
                html += '<div>' + rec.text + '</div>';
                html += '</div>';
            });

            html += '</div>';
            html += '</div>';

            html += '<div class="risk-card">';
            html += '<h3 style="margin-bottom: 15px;">⚕️ 異常症狀清單</h3>';
            if (abnormalSymptoms.length > 0) {
                html += '<table class="symptoms-table">';
                html += '<thead><tr>';
                html += '<th>症狀領域</th>';
                html += '<th>項目</th>';
                html += '<th>回答</th>';
                html += '</tr></thead>';
                html += '<tbody>';
                abnormalSymptoms.forEach(function(symptom) {
                    html += '<tr>';
                    html += '<td>' + symptom.section + '</td>';
                    html += '<td>' + symptom.question + '</td>';
                    html += '<td class="symptom-positive">' + symptom.response + '</td>';
                    html += '</tr>';
                });
                html += '</tbody>';
                html += '</table>';
            } else {
                html += '<p style="color: #16a34a; font-weight: 600;">✓ 未發現明顯異常症狀</p>';
            }
            html += '</div>';

            html += '<div class="disclaimer">';
            html += '<h3>⚠️ 重要聲明</h3>';
            html += '<ul>';
            html += '<li>本工具僅供初步篩檢使用，不能取代專業醫療診斷</li>';
            html += '<li>失智症診斷需要完整的神經學檢查、認知功能評估、腦部影像及實驗室檢查</li>';
            html += '<li>評估結果受教育程度、文化背景、年齡等因素影響</li>';
            html += '<li>請務必將本報告提供給專科醫師，進行完整的臨床評估</li>';
            html += '<li>若有急性意識改變、嚴重記憶喪失或其他緊急症狀，請立即就醫</li>';
            html += '</ul>';
            html += '</div>';

            html += '<div class="info-box">';
            html += '<h3>📊 資料收集與分析說明</h3>';
            html += '<ul>';
            html += '<li><strong>下載報告</strong>：點擊「下載報告」會自動下載文字檔，完成後詢問是否返回首頁</li>';
            html += '<li><strong>匯出個案資料</strong>：點擊「匯出資料」可下載JSON格式的完整評估資料</li>';
            html += '<li><strong>返回修改</strong>：可返回任何步驟修改答案，所有已填資料都會保留</li>';
            html += '<li><strong>用於研究分析</strong>：收集多個個案的JSON檔案後，可使用統計軟體（如R、Python、SPSS）進行批次分析</li>';
            html += '<li><strong>資料欄位包含</strong>：基本資料、所有問題回答、計算分數、風險評估等完整資訊</li>';
            html += '<li><strong>隱私保護</strong>：在進行資料收集前，請確保已取得適當的倫理審查與受試者同意</li>';
            html += '</ul>';
            html += '</div>';

            html += '<div class="button-group">';
            html += '<button class="btn btn-secondary" onclick="backToEdit()">✏️ 返回修改</button>';
            html += '<button class="btn btn-primary" onclick="downloadTextReport()">📥 下載報告</button>';
            html += '<button class="btn btn-success" onclick="uploadDataToGitHub()">☁️ 上傳到雲端</button>';
            html += '<button class="btn btn-secondary" onclick="restartAssessment()">🔄 重新開始</button>';
            html += '</div>';

            document.getElementById('questionSteps').classList.add('hidden');
            document.getElementById('resultsPage').innerHTML = html;
            document.getElementById('resultsPage').classList.remove('hidden');
            document.getElementById('progressFill').style.width = '100%';
            document.getElementById('progressText').textContent = '評估完成';
            window.scrollTo(0, 0);
        }

        // 返回修改答案
        function backToEdit() {
            document.getElementById('resultsPage').classList.add('hidden');
            currentStep = 1;
            showStep(currentStep);
            window.scrollTo(0, 0);
        }

        // 下載文字報告
        function downloadTextReport() {
            const results = calculateScores();
            const recsData = generateRecommendations(results);
            const sorted = recsData.sorted;
            const recommendations = recsData.recommendations;
            const abnormalSymptoms = getAbnormalSymptoms();
            const riskInfo = getRiskInfo(results.overallRisk);
            const age = calculateAge(patientInfo.birthDate);

            let report = '\n';
            report += '═══════════════════════════════════════════════════════════════\n';
            report += '              臨床病史失智診斷結構性問卷 - 評估報告\n';
            report += '═══════════════════════════════════════════════════════════════\n\n';
            report += '【基本資料】\n';
            report += '────────────────────────────────────────────────\n';
            report += '病患姓名：' + patientInfo.name + '\n';
            report += '病歷號：' + patientInfo.chartNumber + '\n';
            report += '出生日期：' + patientInfo.birthDate + (age ? ' (' + age + '歲)' : '') + '\n';
            report += '性別：' + patientInfo.gender + '\n';
            report += '教育程度：' + (patientInfo.education || '未填寫') + '\n';
            report += '評估日期：' + patientInfo.assessmentDate + '\n';
            report += '資訊提供者：' + patientInfo.informantName + '（' + patientInfo.informantRelation + '）\n\n';
            report += '【評估結果摘要】\n';
            report += '────────────────────────────────────────────────\n';
            report += '整體認知障礙風險等級：' + riskInfo.text + '\n';
            report += '日常功能障礙程度：' + results.adlImpairment.toFixed(1) + '%\n\n';
            report += '【各類型失智症相對機率分析】\n';
            report += '────────────────────────────────────────────────\n';

            sorted.forEach(function(item) {
                const type = item[0];
                const prob = item[1];
                report += getDementiaName(type) + '：' + prob.toFixed(1) + '%\n';
            });

            report += '\n【臨床建議】\n';
            report += '────────────────────────────────────────────────\n';

            recommendations.forEach(function(rec, idx) {
                const label = rec.type === 'urgent' ? '⚠ 重要' :
                             rec.type === 'important' ? '▶ 建議' :
                             rec.type === 'clinical' ? '📋 臨床檢查' : '🛡 安全提醒';
                report += (idx + 1) + '. [' + label + '] ' + rec.text + '\n\n';
            });

            report += '\n【異常症狀清單】\n';
            report += '────────────────────────────────────────────────\n';

            if (abnormalSymptoms.length > 0) {
                abnormalSymptoms.forEach(function(symptom, idx) {
                    report += (idx + 1) + '. ' + symptom.section + '\n';
                    report += '   問題：' + symptom.question + '\n';
                    report += '   回答：' + symptom.response + '\n\n';
                });
            } else {
                report += '未發現明顯異常症狀\n\n';
            }

            report += '\n【重要聲明】\n';
            report += '────────────────────────────────────────────────\n';
            report += '⚠ 本工具僅供初步篩檢使用，不能取代專業醫療診斷\n\n';
            report += '1. 失智症診斷需要完整的神經學檢查、認知功能評估、腦部影像\n';
            report += '   及實驗室檢查\n\n';
            report += '2. 評估結果受教育程度、文化背景、年齡等因素影響\n\n';
            report += '3. 請務必將本報告提供給專科醫師，進行完整的臨床評估\n\n';
            report += '4. 若有急性意識改變、嚴重記憶喪失或其他緊急症狀，請立即就醫\n\n';
            report += '════════════════════════════════════════════════════════════════\n';
            report += '報告生成時間：' + new Date().toLocaleString('zh-TW') + '\n';
            report += '本報告由AI輔助評估工具生成，僅供臨床參考\n';
            report += '════════════════════════════════════════════════════════════════\n';

            const blob = new Blob([report], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = '失智症評估報告_' + patientInfo.name + '_' + patientInfo.assessmentDate + '.txt';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            setTimeout(function() {
                if (confirm('報告已開始下載！\n\n是否要返回首頁重新評估？')) {
                    restartAssessment();
                }
            }, 500);
        }

        // 匯出JSON資料
        function downloadJSONData() {
            const results = calculateScores();
            const recsData = generateRecommendations(results);
            const sorted = recsData.sorted;
            const recommendations = recsData.recommendations;
            const abnormalSymptoms = getAbnormalSymptoms();
            const age = calculateAge(patientInfo.birthDate);

            const exportData = {
                metadata: {
                    exportDate: new Date().toISOString(),
                    assessmentDate: patientInfo.assessmentDate,
                    toolVersion: '2.0'
                },
                patientInfo: Object.assign({}, patientInfo, { age: age }),
                responses: responses,
                results: {
                    overallRisk: results.overallRisk,
                    adlImpairment: results.adlImpairment,
                    rawScores: results.rawScores,
                    percentages: results.percentages,
                    probabilities: results.probabilities,
                    dementiaTypeProbabilities: sorted.map(function(item) {
                        return {
                            type: item[0],
                            name: getDementiaName(item[0]),
                            probability: item[1]
                        };
                    })
                },
                abnormalSymptoms: abnormalSymptoms,
                recommendations: recommendations.map(function(rec) {
                    return {
                        type: rec.type,
                        text: rec.text
                    };
                })
            };

            const jsonString = JSON.stringify(exportData, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = '評估資料_' + patientInfo.name + '_' + patientInfo.assessmentDate + '_' + Date.now() + '.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            setTimeout(function() {
                if (confirm('💾 資料已下載到本機\n\n📤 是否要同時上傳到 GitHub 進行自動統計分析？')) {
                    const filename = '評估資料_' + patientInfo.chartNumber + '_' + Date.now() + '.json';
                    uploadToGitHub(jsonString, filename);
                }
                
                setTimeout(function() {
                    if (confirm('是否要返回首頁重新評估？')) {
                        restartAssessment();
                    }
                }, 1000);
            }, 500);
        }

        // 重新評估
        function restartAssessment() {
            currentStep = 0;
            responses = {};
            patientInfo = {};
            document.getElementById('resultsPage').classList.add('hidden');
            document.getElementById('questionSteps').classList.add('hidden');
            document.getElementById('step0').classList.remove('hidden');
            document.getElementById('patientName').value = '';
            document.getElementById('chartNumber').value = '';
            document.getElementById('birthDate').value = '';
            document.getElementById('gender').value = '';
            document.getElementById('education').value = '';
            document.getElementById('assessmentDate').valueAsDate = new Date();
            document.getElementById('informantName').value = '';
            document.getElementById('informantRelation').value = '';
            updateProgress();
            window.scrollTo(0, 0);
        }

        // 初始化
        // 上傳到 GitHub
        function uploadToGitHub(jsonData, filename) {
            const repoOwner = 'a7662888';
            const repoName = 'dementia-assessment';
            const branch = 'main';
            
            // 從 localStorage 讀取 token
            let token = localStorage.getItem('github_token');
            
            if (!token) {
                token = prompt('⚙️ GitHub 設定\n\n請輸入您的 GitHub Personal Access Token\n\n📝 如何取得 Token:\n1. GitHub → Settings → Developer settings\n2. Personal access tokens → Tokens (classic)\n3. Generate new token\n4. 權限選擇: repo (Full control)\n\n💡 Token 會安全儲存在本機，下次不用再輸入');
                
                if (!token) {
                    return;
                }
                
                // 儲存 token
                if (confirm('是否要將 Token 儲存在本機？\n(下次使用就不用再輸入)')) {
                    localStorage.setItem('github_token', token);
                }
            }
            
            // Base64 編碼
            const content = btoa(unescape(encodeURIComponent(jsonData)));
            
            const url = 'https://api.github.com/repos/' + repoOwner + '/' + repoName + '/contents/data/' + filename;
            
            // 顯示上傳中訊息
            const uploadMsg = document.createElement('div');
            uploadMsg.style.cssText = 'position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(59, 130, 246, 0.95); color: white; padding: 30px; border-radius: 15px; z-index: 10000; text-align: center; font-size: 18px; box-shadow: 0 10px 40px rgba(0,0,0,0.3);';
            uploadMsg.innerHTML = '⏳ 正在上傳到 GitHub...<br><small style="font-size: 14px; opacity: 0.9;">請稍候</small>';
            document.body.appendChild(uploadMsg);
            
            fetch(url, {
                method: 'PUT',
                headers: {
                    'Authorization': 'token ' + token,
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    message: '📝 新增評估資料: ' + patientInfo.name + ' (' + patientInfo.assessmentDate + ')',
                    content: content,
                    branch: branch
                })
            })
            .then(function(response) {
                document.body.removeChild(uploadMsg);
                
                if (response.ok) {
                    alert('✅ 上傳成功！\n\n資料已上傳到 GitHub\n系統將自動生成統計報表\n\n📊 約 1-2 分鐘後可至 reports/ 資料夾查看\n\n🔗 Repository: https://github.com/' + repoOwner + '/' + repoName);
                } else if (response.status === 401) {
                    localStorage.removeItem('github_token');
                    throw new Error('Token 無效或已過期，請重新輸入');
                } else if (response.status === 422) {
                    throw new Error('檔案已存在，請稍後再試或修改檔案名稱');
                } else {
                    return response.json().then(function(err) {
                        throw new Error(err.message || '上傳失敗');
                    });
                }
            })
            .catch(function(error) {
                if (uploadMsg.parentNode) {
                    document.body.removeChild(uploadMsg);
                }
                
                alert('❌ 上傳失敗\n\n錯誤訊息: ' + error.message + '\n\n請確認:\n✓ Token 是否正確\n✓ Repository 權限是否足夠\n✓ 網路連線是否正常');
                
                if (error.message.includes('Token')) {
                    localStorage.removeItem('github_token');
                }
            });
        }
        
// 清除儲存的 Token
        function clearGitHubToken() {
            if (confirm('確定要清除已儲存的 GitHub Token 嗎？')) {
                localStorage.removeItem('github_token');
                alert('✅ Token 已清除');
            }
        }
        
        // 包裝函數：準備資料並上傳到GitHub
        function uploadDataToGitHub() {
            const results = calculateScores();
            const recsData = generateRecommendations(results);
            const abnormalSymptoms = getAbnormalSymptoms();
            const age = calculateAge(patientInfo.birthDate);
            
            // 準備完整的資料物件
            const exportData = {
                metadata: {
                    exportDate: new Date().toISOString(),
                    assessmentDate: patientInfo.assessmentDate,
                    toolVersion: '2.0'
                },
                patientInfo: Object.assign({}, patientInfo, { age: age }),
                responses: responses,
                results: {
                    overallRisk: results.overallRisk,
                    adlImpairment: results.adlImpairment,
                    rawScores: results.rawScores,
                    percentages: results.percentages,
                    probabilities: results.probabilities,
                    dementiaTypeProbabilities: recsData.sorted.map(function(item) {
                        return {
                            type: item[0],
                            name: getDementiaName(item[0]),
                            probability: item[1]
                        };
                    })
                },
                abnormalSymptoms: abnormalSymptoms,
                recommendations: recsData.recommendations.map(function(rec) {
                    return {
                        type: rec.type,
                        text: rec.text
                    };
                })
            };
            
            // 生成唯一的檔案名稱
            const timestamp = Date.now();
            const filename = `assessment_${patientInfo.chartNumber}_${timestamp}.json`;
            
            // 轉換為 JSON 字串
            const jsonString = JSON.stringify(exportData, null, 2);
            
            // 調用現有的上傳函數
            uploadToGitHub(jsonString, filename);
        }
        
        updateProgress();
    </script>
</body>
</html>
