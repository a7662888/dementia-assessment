<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‡¨åºŠç—…å²å¤±æ™ºè¨ºæ–·çµæ§‹æ€§å•å·  v2.0</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: "Microsoft JhengHei", "å¾®è»Ÿæ­£é»‘é«”", Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 14px;
            opacity: 0.9;
        }

        .version-badge {
            display: inline-block;
            background: #fbbf24;
            color: #1e3a8a;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            margin-top: 10px;
        }

        .progress-bar {
            background: #e5e7eb;
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
            margin: 20px 30px;
        }

        .progress-fill {
            background: linear-gradient(90deg, #3b82f6, #1e40af);
            height: 100%;
            width: 0%;
            transition: width 0.3s ease;
        }

        .progress-text {
            text-align: center;
            color: #6b7280;
            font-size: 14px;
            margin-top: 10px;
        }

        .content {
            padding: 30px;
        }

        .section-title {
            font-size: 22px;
            font-weight: bold;
            color: #1e40af;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 3px solid #dbeafe;
        }

        .section-subtitle {
            color: #6b7280;
            font-size: 14px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-weight: 600;
            color: #374151;
            margin-bottom: 8px;
        }

        .form-label .required {
            color: #dc2626;
        }

        .form-input, .form-select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: #3b82f6;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .question-item {
            padding: 20px;
            background: #f9fafb;
            border-radius: 10px;
            margin-bottom: 15px;
            border-left: 4px solid #3b82f6;
        }

        .question-header {
            display: flex;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .question-number {
            background: #3b82f6;
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 14px;
            margin-right: 12px;
            flex-shrink: 0;
        }

        .question-text {
            font-weight: 500;
            color: #1f2937;
            flex: 1;
        }

        .question-note {
            font-size: 13px;
            color: #6b7280;
            margin: 8px 0 0 44px;
            font-style: italic;
        }

        .radio-group {
            display: flex;
            gap: 20px;
            margin-left: 44px;
            flex-wrap: wrap;
        }

        .radio-group.vertical {
            flex-direction: column;
            gap: 10px;
        }

        .radio-label {
            display: flex;
            align-items: center;
            cursor: pointer;
            padding: 8px 16px;
            border-radius: 8px;
            transition: background-color 0.2s;
        }

        .radio-label:hover {
            background: #e0e7ff;
        }

        .radio-label input[type="radio"] {
            margin-right: 8px;
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .button-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 30px;
        }

        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #3b82f6, #1e40af);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(59, 130, 246, 0.4);
        }

        .btn-secondary {
            background: #6b7280;
            color: white;
        }

        .btn-secondary:hover {
            background: #4b5563;
        }

        .btn-success {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(16, 185, 129, 0.4);
        }

        .btn-info {
            background: #0ea5e9;
            color: white;
        }

        .info-box {
            background: #dbeafe;
            border-left: 4px solid #3b82f6;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .info-box h3 {
            color: #1e40af;
            margin-bottom: 10px;
        }

        .info-box ul {
            list-style-position: inside;
            color: #1e3a8a;
        }

        .info-box li {
            margin-bottom: 5px;
        }

        .results-container {
            padding: 20px;
        }

        .risk-card {
            background: #f9fafb;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 20px;
            border: 2px solid #e5e7eb;
        }

        .risk-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .risk-item {
            text-align: center;
            padding: 15px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .risk-label {
            font-size: 14px;
            color: #6b7280;
            margin-bottom: 10px;
        }

        .risk-value {
            font-size: 32px;
            font-weight: bold;
        }

        .risk-high { color: #dc2626; }
        .risk-moderate { color: #ea580c; }
        .risk-mild { color: #ca8a04; }
        .risk-low { color: #16a34a; }

        .confidence-indicator {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 10px;
        }

        .confidence-high {
            background: #dcfce7;
            color: #14532d;
        }

        .confidence-moderate {
            background: #fef3c7;
            color: #78350f;
        }

        .confidence-low {
            background: #fee2e2;
            color: #7f1d1d;
        }

        .probability-bars {
            margin: 20px 0;
        }

        .probability-item {
            margin-bottom: 20px;
        }

        .probability-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .probability-name {
            font-weight: 600;
            color: #374151;
        }

        .probability-percent {
            font-weight: bold;
            color: #3b82f6;
            font-size: 18px;
        }

        .probability-bar {
            width: 100%;
            height: 30px;
            background: #e5e7eb;
            border-radius: 15px;
            overflow: hidden;
            position: relative;
        }

        .probability-fill {
            height: 100%;
            background: linear-gradient(90deg, #3b82f6, #1e40af);
            border-radius: 15px;
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 12px;
            color: white;
            font-weight: bold;
            font-size: 14px;
        }

        .subtype-info {
            background: #eff6ff;
            border-left: 4px solid #3b82f6;
            padding: 15px;
            border-radius: 8px;
            margin-top: 10px;
        }

        .subtype-info h4 {
            color: #1e40af;
            margin-bottom: 5px;
        }

        .recommendations {
            margin: 20px 0;
        }

        .recommendation-item {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 12px;
            border-left: 4px solid;
        }

        .rec-urgent {
            background: #fef2f2;
            border-color: #dc2626;
        }

        .rec-important {
            background: #fff7ed;
            border-color: #ea580c;
        }

        .rec-clinical {
            background: #eff6ff;
            border-color: #3b82f6;
        }

        .rec-safety {
            background: #f0fdf4;
            border-color: #16a34a;
        }

        .rec-title {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .disclaimer {
            background: #fef3c7;
            border: 2px solid #f59e0b;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }

        .disclaimer h3 {
            color: #92400e;
            margin-bottom: 10px;
        }

        .disclaimer ul {
            list-style-position: inside;
            color: #78350f;
        }

        .disclaimer li {
            margin-bottom: 5px;
        }

        .symptoms-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background: white;
            border-radius: 8px;
            overflow: hidden;
        }

        .symptoms-table th {
            background: #f3f4f6;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: #374151;
            border-bottom: 2px solid #e5e7eb;
        }

        .symptoms-table td {
            padding: 12px;
            border-bottom: 1px solid #e5e7eb;
            color: #4b5563;
        }

        .symptoms-table tr:last-child td {
            border-bottom: none;
        }

        .symptom-positive {
            color: #dc2626;
            font-weight: 600;
        }

        .hidden {
            display: none;
        }

        @media print {
            body {
                background: white;
                padding: 0;
            }
            .container {
                box-shadow: none;
            }
            .btn {
                display: none;
            }
        }

        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
            }
            .radio-group {
                flex-direction: column;
            }
            .button-group {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“‹ è‡¨åºŠç—…å²å¤±æ™ºè¨ºæ–·çµæ§‹æ€§å•å·</h1>
            <p>Interactive Assessment Tool - äº’å‹•å¼è©•ä¼°å·¥å…·</p>
            <span class="version-badge">æ•´åˆç‰ˆ v2.0</span>
        </div>

        <div class="progress-bar" id="progressBar">
            <div class="progress-fill" id="progressFill"></div>
        </div>
        <div class="progress-text" id="progressText"></div>

        <div id="step0" class="content">
            <div class="info-box">
                <h3>ğŸ“Œ è©•ä¼°èªªæ˜</h3>
                <ul>
                    <li>æœ¬å•å·ç”¨æ–¼åˆæ­¥è©•ä¼°å¤±æ™ºç—‡é¢¨éšªï¼Œä¸èƒ½å–ä»£å°ˆæ¥­é†«ç™‚è¨ºæ–·</li>
                    <li>è«‹ç”±äº†è§£æ‚£è€…ç‹€æ³çš„å®¶å±¬æˆ–ç…§é¡§è€…å”åŠ©å¡«å¯«</li>
                    <li>è©•ä¼°ç´„éœ€10-15åˆ†é˜ï¼Œè«‹ä¾å¯¦éš›æƒ…æ³èª å¯¦ä½œç­”</li>
                    <li>æœªå‹¾é¸çš„é¡Œç›®å°‡è¦–ç‚ºã€Œç„¡æ­¤ç—‡ç‹€ã€ï¼ˆæ­£å¸¸ï¼‰</li>
                    <li><strong>å®Œæˆè©•ä¼°å¾Œï¼Œè³‡æ–™å°‡è‡ªå‹•åŠ å¯†å„²å­˜è‡³é›²ç«¯</strong></li>
                    <li>å®Œæˆå¾Œå¯ä¸‹è¼‰å®Œæ•´å ±å‘Šæˆ–åŒ¯å‡ºè³‡æ–™ä¾›åˆ†æ</li>
                </ul>
            </div>

            <div class="info-box" style="background: #fee2e2; border-left-color: #dc2626;">
                <h3>ğŸ†• v2.0 ç‰ˆæœ¬æ›´æ–°</h3>
                <ul>
                    <li>(v2.0) æ–°å¢ PDD ç‚ºç¨ç«‹è¨ºæ–·ï¼Œä¸¦ä¾ã€Œä¸€å¹´æ¢æ¬¾ã€è‡ªå‹•å€åˆ† PDD/DLB</li>
                    <li>(v2.0) å¼·åŒ– Lewy é«”å…‰è­œç—‡ç‹€æ¬Šé‡ (x2.0)ï¼Œæå‡é‘‘åˆ¥åº¦</li>
                    <li>(v2.0) æ–°å¢ä¸­é¢¨ç—…å²å° AD/PDD/DLB çš„è¨ºæ–·æ’æ–¥æ¬Šé‡</li>
                    </li>
                </ul>
            </div>

            <div class="section-title">ğŸ‘¤ åŸºæœ¬è³‡æ–™</div>
            <div class="form-grid">
                <div class="form-group">
                    <label class="form-label">ç—…æ‚£å§“å <span class="required">*</span></label>
                    <input type="text" id="patientName" class="form-input" placeholder="è«‹è¼¸å…¥å§“å">
                </div>
                <div class="form-group">
                    <label class="form-label">ç—…æ­·è™Ÿ <span class="required">*</span></label>
                    <input type="text" id="chartNumber" class="form-input" placeholder="è«‹è¼¸å…¥ç—…æ­·è™Ÿ">
                </div>
                <div class="form-group">
                    <label class="form-label">å‡ºç”Ÿæ—¥æœŸ <span class="required">*</span></label>
                    <input type="date" id="birthDate" class="form-input">
                </div>
                <div class="form-group">
                    <label class="form-label">æ€§åˆ¥ <span class="required">*</span></label>
                    <select id="gender" class="form-select">
                        <option value="">è«‹é¸æ“‡</option>
                        <option value="ç”·">ç”·</option>
                        <option value="å¥³">å¥³</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">æ•™è‚²ç¨‹åº¦</label>
                    <select id="education" class="form-select">
                        <option value="">è«‹é¸æ“‡</option>
                        <option value="ä¸è­˜å­—">ä¸è­˜å­—</option>
                        <option value="å°å­¸">å°å­¸</option>
                        <option value="åœ‹ä¸­">åœ‹ä¸­</option>
                        <option value="é«˜ä¸­è·">é«˜ä¸­è·</option>
                        <option value="å°ˆç§‘">å°ˆç§‘</option>
                        <option value="å¤§å­¸">å¤§å­¸</option>
                        <option value="ç ”ç©¶æ‰€ä»¥ä¸Š">ç ”ç©¶æ‰€ä»¥ä¸Š</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">è©•ä¼°æ—¥æœŸ</label>
                    <input type="date" id="assessmentDate" class="form-input">
                </div>
                <div class="form-group">
                    <label class="form-label">è³‡è¨Šæä¾›è€…å§“å <span class="required">*</span></label>
                    <input type="text" id="informantName" class="form-input" placeholder="å¡«å¯«è€…å§“å">
                </div>
                <div class="form-group">
                    <label class="form-label">èˆ‡æ‚£è€…é—œä¿‚ <span class="required">*</span></label>
                    <input type="text" id="informantRelation" class="form-input" placeholder="ä¾‹å¦‚ï¼šé…å¶ã€å­å¥³ã€ç…§é¡§è€…">
                </div>
            </div>

            <div class="button-group">
                <button class="btn btn-primary" onclick="startAssessment()">
                    é–‹å§‹è©•ä¼° â†’
                </button>
            </div>
        </div>

        <div id="questionSteps" class="content hidden"></div>

        <div id="resultsPage" class="content hidden"></div>
    </div>

    <script>
        // å…¨å±€è®Šæ•¸
        let currentStep = 0;
        let responses = {};
        let patientInfo = {};
        let globalResults = {}; 

        // å„ªåŒ–ç‰ˆå•å·çµæ§‹ v2.0
        const questionSections = [
            {
                id: 'consciousness',
                title: 'ä¸€ã€æ„è­˜æˆ–ç¡çœ ç—‡ç‹€',
                subtitle: '(ä¸æ¸…æ¥šæˆ–æ˜¯ä¸ç¢ºå®šè«‹é¸å¦)',
                questions: [
                    { id: 'dlb1_1', text: 'ç™½å¤©å—œç¡æˆ–ç¶“å¸¸æ˜æ˜æ¬²ç¡', type: 'yesno' },
                    { id: 'dlb1_3', text: 'æ„è­˜æˆ–èªçŸ¥ç—‡ç‹€èµ·ä¼å¾ˆå¤§ï¼Œç”šè‡³ä¸€å¤©ä¹‹å…§å¥½å£å°±å·®å¾ˆå¤šå—ï¼Ÿ', type: 'noyes' },
                    { id: 'dlb1_4', text: 'ç¡è¦ºæ™‚å› ç‚ºå¤¢å¢ƒè€Œç”¢ç”Ÿä¸€äº›å‹•ä½œè¡Œç‚ºï¼Œä¾‹å¦‚ï¼šå–Šå«ã€æ®æ‹³ã€æ®èˆé›™è‡‚ã€èµ·èº«è·‘ç­‰', type: 'yesno' }
                ]
            },
            {
                id: 'motor',
                title: 'äºŒã€å‹•ä½œéšœç¤™ç—‡ç‹€',
                subtitle: '(ä¸æ¸…æ¥šæˆ–æ˜¯ä¸ç¢ºå®šè«‹é¸å¦)',
                questions: [
                    { id: 'dlb2_1', text: 'åè‘—æˆ–éœæ­¢ä¸å‹•çš„æ™‚å€™ï¼Œè‚¢é«”æˆ–é ­éƒ¨æœƒæ˜é¡¯åœ°é¡«æŠ–', type: 'yesno' },
                    { id: 'dlb2_2', text: 'å‹•ä½œè®Šå¾—ç·©æ…¢ï¼Œå°¤å…¶æ˜¯èµ·æ­¥ç‰¹åˆ¥å›°é›£ï¼Œé¢éƒ¨è¡¨æƒ…ä¹Ÿæ˜é¡¯æ¸›å°‘', type: 'yesno' },
                    { id: 'dlb2_3', text: 'å‹•ä½œè®Šå¾—åƒµç¡¬ï¼Œèµ°è·¯æ­¥ä¼è®Šå°èº«é«”æœƒå‰å‚¾', type: 'yesno' },
                    { id: 'dlb2_4', text: 'å‹•ä½œè®Šå¾—ä¸ç©©ï¼Œèµ°è·¯ä¸å¹³è¡¡ï¼Œæœ‰æ™‚å€™å¥½åƒè¦è·Œå€’æˆ–çœŸçš„è·Œå€’', type: 'yesno' },
                    { 
                        id: 'dlb_temporal', 
                        text: 'èªçŸ¥å•é¡Œèˆ‡å‹•ä½œå•é¡Œä½•è€…å…ˆå‡ºç¾ï¼Ÿ', 
                        type: 'temporal',
                        options: [
                            'èªçŸ¥å…ˆæˆ–åŒæ™‚ï¼ˆ1å¹´å…§ï¼‰',
                            'å‹•ä½œå…ˆè¶…é1å¹´',
                            'åªæœ‰èªçŸ¥å•é¡Œ',
                            'åªæœ‰å‹•ä½œå•é¡Œ',
                            'ä¸ç¢ºå®š'
                        ]
                    }
                ]
            },
            {
                id: 'behavioral',
                title: 'ä¸‰ã€æƒ…ç·’è¡Œç‚ºç—‡ç‹€',
                subtitle: '(ä¸æ¸…æ¥šæˆ–æ˜¯ä¸ç¢ºå®šè«‹é¸å¦)',
                questions: [
                    { id: 'dlb3_1', text: 'æœ‰è¦–å¹»è¦ºï¼Œæœƒã€Œæ¸…æ¥šã€åœ°çœ‹è¦‹åˆ¥äººçœ‹ä¸åˆ°çš„äººã€å‹•ç‰©æˆ–å…¶ä»–ç‰©é«”', type: 'yesno', note: '(è¨»ï¼šåªåƒæ˜¯éå»çš„ç‰‡æ®µè¨˜æ†¶ä¸ç®—ï¼›åªå°ç©ºæ°£è¬›è©±ä¸ç®—ï¼›åŠå¤¢åŠé†’æˆ–æ˜¯è¦–åŠ›ä¸ä½³çœ‹åˆ°çš„é»‘å½±æˆ–éŒ¯è¦ºä¹Ÿä¸ç®—)' },
                    { id: 'dlb3_2', text: 'è®Šå¾—å¤šç–‘æˆ–å¦„æƒ³ï¼Œå¸¸å¸¸æœ‰ä¸€äº›èˆ‡äº‹å¯¦ä¸ç¬¦çš„æƒ³æ³•ï¼Œä¾‹å¦‚ï¼šéŒ¢è²¡è¢«å·æˆ–äººè¢«å‚·å®³', type: 'yesno' },
                    { id: 'dlb3_3', text: 'è®Šå¾—æƒ…ç·’ä½è½ã€æ†‚é¬±ã€æœ‰è² é¢æƒ³æ³•ï¼Œæˆ–æ˜¯å€¦æ€ ä¹åŠ›', type: 'yesno' },
                    { id: 'ftd3_4', text: 'è®Šå¾—èºå‹•ï¼Œæƒ…ç·’ä¸å®¹æ˜“æ§åˆ¶ï¼Œç”šè‡³æœƒç”¨è¨€èªæˆ–å‹•ä½œå‚·å®³åˆ¥äºº', type: 'yesno' },
                    { id: 'ftd3_5', text: 'è®Šå¾—å†·æ¼ ï¼Œå°å‘¨é‚Šçš„äº‹ç‰©å¤±å»å‹•åŠ›æˆ–èˆˆè¶£', type: 'yesno' },
                    { id: 'ftd3_6', text: 'è®Šå¾—ç¼ºä¹åŒç†å¿ƒï¼Œæ¯«ä¸åœ¨æ„å¤–ç•Œçš„æƒ³æ³•èˆ‡æ„Ÿå—ï¼Œä¹Ÿä¸æœƒåŒæƒ…åˆ¥äºº', type: 'yesno' },
                    { id: 'ftd3_7', text: 'ç”¢ç”Ÿæ€ªç•°è¡Œç‚ºã€é‡è¤‡çš„å‹•ä½œï¼Œæˆ–æ˜¯å¼·è¿«æ€§çš„è¨€èªæˆ–è¡Œç‚º', type: 'yesno' },
                    { id: 'ftd3_8', text: 'é£²é£Ÿå–œå¥½æ”¹è®Šï¼Œæˆ–æ›´é…—è¸æˆ–é…’ï¼Œä¸æ­£å¸¸åœ°åƒç”œé£Ÿï¼Œæˆ–å°‡ä¸å¯åƒçš„æ±è¥¿æ”¾å…¥å£è£¡', type: 'yesno' },
                    { id: 'ftd3_9', text: 'å‡ºç¾ç¤¾äº¤ä¸é©åˆ‡è¡Œç‚ºã€å¤±å»ç¦®å„€æˆ–åšå‡ºè¡å‹•é­¯è½çš„èˆ‰å‹•', type: 'yesno' }
                ]
            },
            {
                id: 'autonomic',
                title: 'å››ã€è‡ªå¾‹ç¥ç¶“ç—‡ç‹€',
                subtitle: '(ä¸æ¸…æ¥šæˆ–æ˜¯ä¸ç¢ºå®šè«‹é¸å¦)',
                questions: [
                    { id: 'vad4_1', text: 'ç¶“å¸¸æœ‰æ’å°¿å•é¡Œ', type: 'yesno' },
                    { id: 'dlb4_2', text: 'ç¶“å¸¸é ­æšˆï¼Œå°¤å…¶æ˜¯åœ¨è®Šæ›å§¿å‹¢çš„æ™‚å€™', type: 'yesno' },
                    { id: 'dlb4_3', text: 'æ›¾æœ‰çŸ­æš«æ„è­˜å–ªå¤±', type: 'yesno' }
                ]
            },
            {
                id: 'memory',
                title: 'äº”ã€è¨˜æ†¶åŠ›ç—‡ç‹€',
                subtitle: '(ä¸æ¸…æ¥šæˆ–æ˜¯ä¸ç¢ºå®šè«‹é¸ä¸æœƒ)',
                questions: [
                    { id: 'ad5_1', text: 'æœƒå¿˜è¨˜ç†Ÿæ‚‰è¦ªäººæˆ–æœ‹å‹çš„åå­—å—ï¼Ÿ', type: 'frequency3' },
                    { id: 'ad5_2', text: 'æœƒé‡è¤‡å•ç›¸åŒçš„å•é¡Œæˆ–è¬›ç›¸åŒçš„äº‹æƒ…å—ï¼Ÿ', type: 'frequency3' },
                    { id: 'ad5_3', text: 'æœƒå¿˜è¨˜èˆ‡åˆ¥äººçš„é‡è¦ç´„æœƒå—ï¼Ÿ', type: 'frequency3' },
                    { id: 'ad5_4', text: 'å­¸ç¿’å¦‚ä½•ä½¿ç”¨æ–°çš„å·¥å…·è¨­å‚™ï¼ˆä¾‹å¦‚ï¼šæ‰‹æ©Ÿæˆ–å…¶ä»–é›»å­ç”¢å“ï¼‰æœƒè®Šå¾—å›°é›£å—ï¼Ÿ', type: 'frequency3' },
                    { id: 'ad5_6', text: 'æœƒå¸¸å¸¸å¿˜è¨˜æœ€è¿‘ç™¼ç”Ÿçš„äº‹æƒ…å—ï¼Ÿ', type: 'frequency3' },
                    { id: 'ad5_8', text: 'æœƒå› ç‚ºå›ç­”ä¸å‡ºå•é¡Œæˆ–æ˜¯åˆ†ä¸æ¸…æ¥šéå»ç¾åœ¨ï¼Œå°±äº‚ç·¨æ•…äº‹å—ï¼Ÿ', type: 'frequency3' }
                ]
            },
            {
                id: 'orientation',
                title: 'å…­ã€å®šå‘åŠ›ç—‡ç‹€',
                subtitle: '(ä¸æ¸…æ¥šæˆ–æ˜¯ä¸ç¢ºå®šè«‹é¸ä¸æœƒ)',
                questions: [
                    { id: 'ad6_1', text: 'æœƒå¿˜è¨˜æ­£ç¢ºçš„å¹´ä»½å’Œæœˆä»½å—ï¼Ÿ', type: 'frequency3' },
                    { id: 'ad6_2', text: 'åœ¨ç†Ÿæ‚‰çš„ç’°å¢ƒï¼ˆä¾‹å¦‚ï¼šä½å®¶é™„è¿‘ï¼‰æœƒè¿·è·¯å—ï¼Ÿ', type: 'frequency3' },
                    { id: 'ad6_3', text: 'å°‹æ‰¾ç‰©å“ï¼ˆä¾‹å¦‚ï¼šæ‰¾å†°ç®±æˆ–æ«ƒå­å…§ç‰©å“ï¼‰æœƒæœ‰å›°é›£å—ï¼Ÿ', type: 'frequency3' },
                    { id: 'ad6_4', text: 'æœƒç„¡æ³•è¾¨èªè¦ªäººè‡‰å­”ã€è‡ªå®¶å»ºç¯‰æˆ¿é–“æˆ–è‡ªå·±çš„ç‰©å“å—ï¼Ÿ', type: 'frequency3' }
                ]
            },
            {
                id: 'executive',
                title: 'ä¸ƒã€åˆ¤æ–·åŠ›èˆ‡åŸ·è¡ŒåŠŸèƒ½ç—‡ç‹€',
                subtitle: '(ä¸æ¸…æ¥šæˆ–æ˜¯ä¸ç¢ºå®šè«‹é¸ä¸æœƒ)',
                questions: [
                    { id: 'ftd7_1', text: 'æ‡‰å°é€²é€€ï¼ˆä¾‹å¦‚ï¼šåƒåŠ è¦ªæœ‹å¥½å‹å©šå–ªå–œæ…¶ï¼‰æœƒæœ‰ä¸é©ç•¶è¨€è¡Œèˆ‰æ­¢å—ï¼Ÿ', type: 'frequency3' },
                    { id: 'vad7_2', text: 'åšå‡ºéŒ¯èª¤çš„åˆ¤æ–·æˆ–æ±ºå®šå—ï¼Ÿä¾‹å¦‚ï¼šè¢«é¨™ã€è²·ä¸é©å®œç‰©å“ã€ä¸é¡§å®‰å±ç­‰', type: 'frequency3' },
                    { id: 'vad7_3', text: 'è™•ç†è¤‡é›œçš„è²¡å‹™ï¼Œä¾‹å¦‚ï¼šä¸ŠéŠ€è¡Œã€ç¹³è²»ã€é–‹æ”¯ç¥¨ç­‰æœƒè®Šå¾—å›°é›£å—ï¼Ÿ', type: 'frequency3' },
                    { id: 'vad7_4', text: 'è®Šå¾—å¾ˆå›°é›£è¨ˆç•«å®‰æ’æˆ–ä¸‹æ±ºå®šå—ï¼Ÿ', type: 'decision' },
                    { id: 'vad7_5', text: 'è®Šå¾—ä¸çŸ¥äº‹æƒ…çš„è¼•é‡ç·©æ€¥ï¼ˆé‡è¦æ€§ï¼‰ï¼ŒæéŒ¯é †åºå—ï¼Ÿ', type: 'frequency3' },
                    { id: 'vad7_6', text: 'æ“ä½œæ—¥å¸¸ç”Ÿæ´»ç”¨å“æ˜é¡¯æ¯”ä»¥å‰å›°é›£å—ï¼Ÿä¾‹å¦‚ï¼šä½¿ç”¨é›»è©±ã€é™æ§å™¨ï¼Œæˆ–å¾®æ³¢çˆç­‰', type: 'frequency3' },
                    { id: 'vad7_8', text: 'æœƒå¸¸å¸¸å¿˜è¨˜é—œç“¦æ–¯ã€æ°´é¾é ­æˆ–é›»å™¨å—ï¼Ÿ', type: 'frequency3' },
                    { id: 'vad7_9', text: 'åæ‡‰é€Ÿåº¦æ˜é¡¯è®Šæ…¢å—ï¼Ÿ', type: 'frequency3' }
                ]
            },
            {
                id: 'language',
                title: 'å…«ã€èªè¨€åŠŸèƒ½ç—‡ç‹€',
                subtitle: '(ä¸æ¸…æ¥šæˆ–æ˜¯ä¸ç¢ºå®šè«‹é¸å¦æˆ–ä¸æœƒ)',
                questions: [
                    { id: 'ppa8_1', text: 'æƒ³è¦è¬›æŸå€‹åè©ä¾‹å¦‚äººåæˆ–ç‰©åå»å¸¸å¸¸è¬›ä¸å‡ºä¾†å—ï¼Ÿ', type: 'frequency3' },
                    { id: 'ppa8_2', text: 'èªªè©±æœƒè®Šå¾—å¾ˆå°‘æˆ–è®Šå¾—ä¸æµåˆ©ï¼Œç„¡æ³•å®Œæ•´åœ°è¬›ä¸€å€‹å¥å­å—ï¼Ÿ', type: 'frequency3' },
                    { id: 'ppa8_3', text: 'èªªè©±è®Šå¾—å®¹æ˜“èªªéŒ¯è©±æˆ–æ–‡æ³•éŒ¯èª¤ï¼Ÿ', type: 'frequency3' },
                    { id: 'ppa8_4', text: 'æœƒè®Šå¾—è½ä¸æ‡‚åˆ¥äººçš„è©±æˆ–ç„¡æ³•ç†è§£æ–‡æ„å—ï¼Ÿ', type: 'frequency3' },
                    { id: 'ftd8_6', text: 'èªè¨€åŠŸèƒ½ç•°å¸¸æ˜¯å¦æœ€æ—©ç™¼ç”Ÿï¼Œè€Œä¸”æ¯”å…¶ä»–èªçŸ¥ç—‡ç‹€æ—©å¾ˆå¤šå—ï¼Ÿ', type: 'yesno' },
                    { id: 'ppa8_7', text: 'æœƒå°å–®ä¸€è©å½™ç†è§£å›°é›£å—ï¼Ÿï¼ˆå¦‚ä¸æ‡‚å¸¸è¦‹ç‰©å“åç¨±ï¼‰', type: 'frequency3' },
                    { id: 'ppa8_8', text: 'è¤‡è¿°å¥å­æœƒæœ‰å›°é›£å—ï¼Ÿ', type: 'frequency3' }
                ]
            },
            {
                id: 'adl',
                title: 'ä¹ã€æ—¥å¸¸ç”Ÿæ´»ç‹€æ³',
                subtitle: '(è«‹ç…§é¡§è€…å‹™å¿…ä¾ç—…æ‚£ç¾éšæ®µèƒ½åŠ›é¸æ“‡å…¶ä¸­ä¸€å€‹é …ç›®)',
                questions: [
                    { 
                        id: 'adl9_1', 
                        text: 'èƒ½ä¸Šè¡—è³¼ç‰©å—ï¼Ÿ', 
                        type: 'adl3',
                        options: ['èƒ½ç¨ç«‹è³¼è²·ç”Ÿæ´»ç”¨å“', 'ä¸Šè¡—è³¼ç‰©éœ€è¦æœ‰äººé™ª', 'å®Œå…¨ä¸æœƒè³¼è²·']
                    },
                    { 
                        id: 'adl9_2', 
                        text: 'èƒ½å¤ è‡ªè¡Œå¤–å‡ºæ´»å‹•å—ï¼Ÿ', 
                        type: 'adl3',
                        options: ['èƒ½è‡ªè¡Œæ­è»Šæˆ–é¨/é–‹è»Š', 'éœ€è¦æœ‰äººé™ªåŒ', 'å®Œå…¨ä¸èƒ½å‡ºé–€']
                    },
                    { 
                        id: 'adl9_3', 
                        text: 'èƒ½å¤ æº–å‚™é£¯èœå—ï¼Ÿ', 
                        type: 'adl4',
                        options: ['ä¸é©ç”¨(å¹³å¸¸æ²’åœ¨åš)', 'æ­£å¸¸æˆ–æœ‰äººå”åŠ©ä¸‹å¯ä»¥', 'éœ€è¦åˆ¥äººæº–å‚™', 'å®Œå…¨ä¾è³´ä»–äºº']
                    },
                    { 
                        id: 'adl9_4', 
                        text: 'èƒ½å¤ åšå®¶äº‹å—ï¼Ÿ', 
                        type: 'adl4',
                        options: ['ä¸é©ç”¨(å¹³å¸¸æ²’åœ¨åš)', 'èƒ½å®Œæˆç°¡å–®å®¶äº‹', 'éœ€è¦å”åŠ©', 'å®Œå…¨ä¾è³´ä»–äºº']
                    },
                    { 
                        id: 'adl9_6', 
                        text: 'èƒ½å¤ ä½¿ç”¨é›»è©±æˆ–æ‰‹æ©Ÿå—ï¼Ÿ', 
                        type: 'adl3',
                        options: ['æ­£å¸¸æˆ–å¯æ’¥ç†Ÿæ‚‰è™Ÿç¢¼', 'åƒ…æœƒæ¥ä¸æœƒæ’¥', 'å®Œå…¨ä¸æœƒ']
                    },
                    { 
                        id: 'adl9_7', 
                        text: 'é‚„èƒ½å¤ è‡ªè¡Œæœç”¨è—¥ç‰©å—ï¼Ÿ', 
                        type: 'adl3',
                        options: ['æ­£å¸¸æˆ–éœ€è¦æé†’', 'åˆ¥äººäº‹å…ˆæº–å‚™å¥½', 'å®Œå…¨ä¾é åˆ¥äºº']
                    },
                    { 
                        id: 'adl9_8', 
                        text: 'èƒ½å¤ è™•ç†éŒ¢è²¡å—ï¼Ÿ', 
                        type: 'adl3',
                        options: ['å¯è™•ç†æ—¥å¸¸è³¼è²·', 'æœ‰å›°é›£', 'å®Œå…¨ç„¡æ³•è™•ç†']
                    },
                    { 
                        id: 'adl9_10', 
                        text: 'ä¸Šè¿°æ´»å‹•å›°é›£ï¼Œç—…äººæ˜¯å› è‚¢é«”æˆ–è¡Œå‹•ä¸ä¾¿å—ï¼Ÿ', 
                        type: 'yesno'
                    }
                ]
            },
            {
                id: 'supplementary',
                title: 'åã€è£œå……è³‡è¨Š',
                subtitle: '(é‡è¦é‘‘åˆ¥è³‡è¨Š)',
                questions: [
                    {
                        id: 'progression',
                        text: 'ç—…ç¨‹é€²å±•æ¨¡å¼',
                        type: 'single_choice',
                        options: ['é€æ¼¸æƒ¡åŒ–', 'éšæ¢¯å¼æƒ¡åŒ–', 'èµ·ä¼ä¸å®š', 'å¿«é€Ÿæƒ¡åŒ–ï¼ˆ<6å€‹æœˆï¼‰']
                    },
                    {
                        id: 'duration',
                        text: 'ç—‡ç‹€å·²æŒçºŒæ™‚é–“',
                        type: 'single_choice',
                        options: ['<6å€‹æœˆ', '6-12å€‹æœˆ', '1-2å¹´', '2-5å¹´', '>5å¹´']
                    },
                    {
                        id: 'stroke_history',
                        text: 'æœ‰ç„¡ä¸­é¢¨ç—…å²',
                        type: 'stroke',
                        options: ['ç„¡', 'æœ‰']
                    },
                    {
                        id: 'family_history',
                        text: 'å¤±æ™ºç—‡å®¶æ—å²',
                        type: 'family',
                        options: ['ç„¡', 'æœ‰ï¼ˆæ—©ç™¼<65æ­²ï¼‰', 'æœ‰ï¼ˆæ™šç™¼â‰¥65æ­²ï¼‰', 'ä¸æ¸…æ¥š']
                    }
                ]
            }
        ];

        // è©•åˆ†æ¬Šé‡ v2.0
        const scoringWeights = {
            LBS: {
                'dlb3_1': 5.0, 'dlb1_3': 4.0, 'dlb1_4': 4.5,
                'dlb2_1': 3.0, 'dlb2_2': 3.5, 'dlb2_3': 3.0, 'dlb2_4': 2.5,
                'dlb1_1': 2.0, 'dlb4_2': 2.5, 'dlb4_3': 2.0
            },
            AD: {
                'ad5_2': 4.5, 'ad5_6': 4.0, 'ad5_8': 3.0, 'ad5_1': 3.0, 'ad5_3': 3.0, 'ad5_4': 2.5,
                'ad6_1': 3.5, 'ad6_2': 3.5, 'ad6_3': 2.5, 'ad6_4': 3.0,
                'dlb3_2': 2.0, 'dlb3_3': 1.5
            },
            FTD: {
                'ftd3_6': 5.0, 'ftd3_5': 4.5, 'ftd7_1': 4.5, 'ftd3_9': 4.0, 'ftd3_7': 4.0, 'ftd3_8': 3.5, 'ftd3_4': 3.0,
                'vad7_2': 3.0, 'vad7_4': 3.0,
                'ftd8_6': 4.0
            },
            VaD: {
                'vad7_2': 4.0, 'vad7_3': 3.5, 'vad7_4': 3.5, 'vad7_5': 3.0, 'vad7_6': 3.0, 'vad7_8': 2.5, 'vad7_9': 3.5,
                'vad4_1': 3.0, 'dlb2_4': 2.5,
                'ad5_2': 2.0, 'ad5_6': 2.0
            },
            PPA: {
                'ftd8_6': 5.0, 'ppa8_1': 3.5, 'ppa8_2': 3.5, 'ppa8_3': 3.0, 'ppa8_4': 3.5, 'ppa8_7': 3.5, 'ppa8_8': 3.0
            }
        };

        // åˆå§‹åŒ–æ—¥æœŸ
        document.getElementById('assessmentDate').valueAsDate = new Date();

        // é–‹å§‹è©•ä¼°
        function startAssessment() {
            const name = document.getElementById('patientName').value.trim();
            const chartNumber = document.getElementById('chartNumber').value.trim();
            const birthDate = document.getElementById('birthDate').value;
            const gender = document.getElementById('gender').value;
            const informantName = document.getElementById('informantName').value.trim();
            const informantRelation = document.getElementById('informantRelation').value.trim();

            if (!name || !chartNumber || !birthDate || !gender || !informantName || !informantRelation) {
                alert('è«‹å¡«å¯«æ‰€æœ‰å¿…å¡«æ¬„ä½ï¼ˆæ¨™è¨» * è€…ï¼‰');
                return;
            }

            patientInfo = {
                name: name,
                chartNumber: chartNumber,
                birthDate: birthDate,
                gender: gender,
                education: document.getElementById('education').value,
                assessmentDate: document.getElementById('assessmentDate').value,
                informantName: informantName,
                informantRelation: informantRelation
            };
            
            globalResults = {}; 

            currentStep = 1;
            showStep(currentStep);
        }

        // é¡¯ç¤ºæ­¥é©Ÿ
        function showStep(step) {
            document.getElementById('step0').classList.add('hidden');
            document.getElementById('questionSteps').classList.remove('hidden');
            document.getElementById('resultsPage').classList.add('hidden');

            const section = questionSections[step - 1];
            let html = '<div class="section-title">' + section.title + '</div>';
            html += '<div class="section-subtitle">' + section.subtitle + '</div>';

            section.questions.forEach(function(q, idx) {
                html += '<div class="question-item">';
                html += '<div class="question-header">';
                html += '<span class="question-number">Q' + (idx + 1) + '</span>';
                html += '<span class="question-text">' + q.text + '</span>';
                html += '</div>';
                if (q.note) {
                    html += '<div class="question-note">' + q.note + '</div>';
                }
                html += renderQuestionInput(q);
                html += '</div>';
            });

            html += '<div class="button-group">';
            html += '<button class="btn btn-secondary" onclick="previousStep()">â† ä¸Šä¸€æ­¥</button>';
            if (step < questionSections.length) {
                html += '<button class="btn btn-primary" onclick="nextStep()">ä¸‹ä¸€æ­¥ â†’</button>';
            } else {
                html += '<button class="btn btn-success" onclick="showResults()">âœ“ å®Œæˆè©•ä¼°</button>';
            }
            html += '</div>';

            document.getElementById('questionSteps').innerHTML = html;
            updateProgress();
            window.scrollTo(0, 0);
        }

        // æ¸²æŸ“å•é¡Œè¼¸å…¥ (v2.0 logic.)
        function renderQuestionInput(question) {
            const savedValue = responses[question.id];
            let html = '';
            
            switch(question.type) {
                case 'yesno':
                    html = '<div class="radio-group">';
                    html += '<label class="radio-label">';
                    html += '<input type="radio" name="' + question.id + '" value="å¦" ' + (savedValue === 'å¦' ? 'checked' : '') + ' onchange="saveResponse(\'' + question.id + '\', \'å¦\')"> å¦';
                    html += '</label>';
                    html += '<label class="radio-label">';
                    html += '<input type="radio" name="' + question.id + '" value="æ˜¯" ' + (savedValue === 'æ˜¯' ? 'checked' : '') + ' onchange="saveResponse(\'' + question.id + '\', \'æ˜¯\')"> æ˜¯';
                    html += '</label>';
                    html += '</div>';
                    break;
                
                case 'noyes':
                    html = '<div class="radio-group">';
                    html += '<label class="radio-label">';
                    html += '<input type="radio" name="' + question.id + '" value="ä¸æœƒ" ' + (savedValue === 'ä¸æœƒ' ? 'checked' : '') + ' onchange="saveResponse(\'' + question.id + '\', \'ä¸æœƒ\')"> ä¸æœƒ';
                    html += '</label>';
                    html += '<label class="radio-label">';
                    html += '<input type="radio" name="' + question.id + '" value="æœƒ" ' + (savedValue === 'æœƒ' ? 'checked' : '') + ' onchange="saveResponse(\'' + question.id + '\', \'æœƒ\')"> æœƒ';
                    html += '</label>';
                    html += '</div>';
                    break;
                
                case 'frequency3':
                    html = '<div class="radio-group">';
                    html += '<label class="radio-label">';
                    html += '<input type="radio" name="' + question.id + '" value="ä¸æœƒ" ' + (savedValue === 'ä¸æœƒ' ? 'checked' : '') + ' onchange="saveResponse(\'' + question.id + '\', \'ä¸æœƒ\')"> ä¸æœƒ';
                    html += '</label>';
                    html += '<label class="radio-label">';
                    html += '<input type="radio" name="' + question.id + '" value="å¶çˆ¾" ' + (savedValue === 'å¶çˆ¾' ? 'checked' : '') + ' onchange="saveResponse(\'' + question.id + '\', \'å¶çˆ¾\')"> å¶çˆ¾';
                    html += '</label>';
                    html += '<label class="radio-label">';
                    html += '<input type="radio" name="' + question.id + '" value="å¸¸å¸¸" ' + (savedValue === 'å¸¸å¸¸' ? 'checked' : '') + ' onchange="saveResponse(\'' + question.id + '\', \'å¸¸å¸¸\')"> å¸¸å¸¸';
                    html += '</label>';
                    html += '</div>';
                    break;
                
                case 'decision':
                    html = '<div class="radio-group vertical">';
                    html += '<label class="radio-label">';
                    html += '<input type="radio" name="' + question.id + '" value="ä¸æœƒ" ' + (savedValue === 'ä¸æœƒ' ? 'checked' : '') + ' onchange="saveResponse(\'' + question.id + '\', \'ä¸æœƒ\')"> ä¸æœƒï¼Œå¤§éƒ½æ˜¯è‡ªå·±æ±ºå®š';
                    html += '</label>';
                    html += '<label class="radio-label">';
                    html += '<input type="radio" name="' + question.id + '" value="æœƒ" ' + (savedValue === 'æœƒ' ? 'checked' : '') + ' onchange="saveResponse(\'' + question.id + '\', \'æœƒ\')"> æœƒï¼Œå¤§éƒ½ç”±åˆ¥äººå¹«å¿™æ±ºå®š';
                    html += '</label>';
                    html += '</div>';
                    break;
                
                case 'adl3':
                case 'adl4':
                case 'single_choice':
                case 'temporal':
                case 'stroke':
                case 'family':
                    html = '<div class="radio-group vertical">';
                    question.options.forEach(function(opt, idx) {
                        html += '<label class="radio-label">';
                        html += '<input type="radio" name="' + question.id + '" value="' + idx + '" ' + (savedValue == idx ? 'checked' : '') + ' onchange="saveResponse(\'' + question.id + '\', ' + idx + ')"> ' + opt;
                        html += '</label>';
                    });
                    html += '</div>';
                    break;
            }
            
            return html;
        }

        // å„²å­˜å›æ‡‰
        function saveResponse(questionId, value) {
            responses[questionId] = value;
        }

        // å„ªåŒ–ç‰ˆï¼šå–å¾—å›æ‡‰å€¼ï¼ˆæœªç­”é¡Œè¦–ç‚ºæ­£å¸¸ï¼‰
        function getResponseValue(questionId) {
            const value = responses[questionId];
            if (value === undefined || value === null || value === '') {
                return 'æ­£å¸¸';
            }
            return value;
        }

        // å„ªåŒ–ç‰ˆï¼šå›æ‡‰å€¼è½‰æ›ç‚ºåˆ†æ•¸ (v2.0 logic)
        function convertToScore(value, questionType) {
            if (value === 'æ­£å¸¸' || value === undefined || value === null || value === '') {
                return 0;
            }
            if (value === 'å¦' || value === 'ä¸æœƒ') return 0;
            if (value === 'æ˜¯' || value === 'æœƒ') return 1;
            if (value === 'å¶çˆ¾') return 0.5;
            if (value === 'å¸¸å¸¸') return 1;
            
            if (questionType === 'adl3') {
                if (value === 0 || value === 'ä¸é©ç”¨') return 0;
                if (value === 1) return 0.5;
                if (value === 2) return 1;
            }
            if (questionType === 'adl4') {
                if (value === 0 || value === 'ä¸é©ç”¨') return 0;
                if (value === 1) return 0;
                if (value === 2) return 0.5;
                if (value === 3) return 1;
            }
            
            if (typeof value === 'number') {
                return value > 0 ? 1 : 0;
            }
            
            return 0;
        }

        // ä¸‹ä¸€æ­¥
        function nextStep() {
            if (currentStep < questionSections.length) {
                currentStep++;
                showStep(currentStep);
            }
        }

        // ä¸Šä¸€æ­¥
        function previousStep() {
            if (currentStep > 1) {
                currentStep--;
                showStep(currentStep);
            } else {
                document.getElementById('step0').classList.remove('hidden');
                document.getElementById('questionSteps').classList.add('hidden');
                currentStep = 0;
                updateProgress();
            }
        }

        // æ›´æ–°é€²åº¦æ¢
        function updateProgress() {
            const progress = (currentStep / questionSections.length) * 100;
            document.getElementById('progressFill').style.width = progress + '%';
            document.getElementById('progressText').textContent = 
                currentStep === 0 ? 'æº–å‚™é–‹å§‹' : 
                'ç¬¬ ' + currentStep + ' éƒ¨åˆ†ï¼Œå…± ' + questionSections.length + ' éƒ¨åˆ† (' + Math.round(progress) + '% å®Œæˆ)';
        }

        // è¨ˆç®—åŸºç¤åˆ†æ•¸ (v2.0 logic)
        function calculateBaseScores() {
            const scores = { LBS: 0, AD: 0, FTD: 0, VaD: 0, PPA: 0 };
            const maxScores = { LBS: 0, AD: 0, FTD: 0, VaD: 0, PPA: 0 };
            
            Object.keys(scoringWeights).forEach(function(diseaseType) {
                Object.keys(scoringWeights[diseaseType]).forEach(function(questionId) {
                    const weight = scoringWeights[diseaseType][questionId];
                    const response = getResponseValue(questionId);
                    
                    let questionType = null;
                    questionSections.forEach(section => {
                        const question = section.questions.find(q => q.id === questionId);
                        if (question) {
                            questionType = question.type;
                        }
                    });
                    
                    const scoreValue = convertToScore(response, questionType);
                    
                    scores[diseaseType] += weight * scoreValue;
                    maxScores[diseaseType] += weight;
                });
            });
            
            return { scores, maxScores };
        }

        // å„ªåŒ–ç‰ˆï¼šè¨ˆç®—ADLæå®³
        function calculateADLImpairment() {
            let impairmentScore = 0;
            let totalItems = 0;
            
            const adlQuestions = [
                'adl9_1', 'adl9_2', 'adl9_3', 'adl9_4',
                'adl9_6', 'adl9_7', 'adl9_8'
            ];
            
            adlQuestions.forEach(function(qId) {
                const response = responses[qId];
                if (response !== undefined && response !== 'ä¸é©ç”¨' && response !== 0) {
                    totalItems++;
                    
                    const question = questionSections.find(s => s.id === 'adl')
                        ?.questions.find(q => q.id === qId);
                    
                    if (question) {
                        if (question.type === 'adl3') {
                            if (response == 2) impairmentScore += 1.0;
                            else if (response == 1) impairmentScore += 0.5;
                        } else if (question.type === 'adl4') {
                            if (response == 3) impairmentScore += 1.0;
                            else if (response == 2) impairmentScore += 0.5;
                        }
                    }
                }
            });
            
            return totalItems > 0 ? (impairmentScore / totalItems) * 100 : 0;
        }

        // æª¢æŸ¥å·´é‡‘æ£®ç—‡ç‹€
        function hasParkinsonian() {
            const motorSymptoms = [
                responses['dlb2_1'] === 'æ˜¯',
                responses['dlb2_2'] === 'æ˜¯',
                responses['dlb2_3'] === 'æ˜¯',
                responses['dlb2_4'] === 'æ˜¯'
            ];
            return motorSymptoms.filter(x => x).length >= 2;
        }

        // è­˜åˆ¥PPAæ¬¡åˆ†å‹ (v2.0 logic)
        function identifyPPASubtype(responses) {
            const subtypes = {
                nfvPPA: 0,  // éæµåˆ©å‹
                svPPA: 0,   // èªæ„å‹
                lvPPA: 0    // ç¼ºè©å‹
            };
            
            if ((responses['ppa8_2'] === 'å¸¸å¸¸' || responses['ppa8_2'] === 'å¶çˆ¾') && 
                (responses['ppa8_3'] === 'å¸¸å¸¸' || responses['ppa8_3'] === 'å¶çˆ¾') && 
                !(responses['ppa8_4'] === 'å¸¸å¸¸' || responses['ppa8_4'] === 'å¶çˆ¾')) {
                subtypes.nfvPPA = 80;
            }
            
            if ((responses['ppa8_7'] === 'å¸¸å¸¸' || responses['ppa8_7'] === 'å¶çˆ¾') && 
                (responses['ppa8_4'] === 'å¸¸å¸¸' || responses['ppa8_4'] === 'å¶çˆ¾')) {
                subtypes.svPPA = 80;
            }
            
            if ((responses['ppa8_1'] === 'å¸¸å¸¸' || responses['ppa8_1'] === 'å¶çˆ¾') && 
                (responses['ppa8_8'] === 'å¸¸å¸¸' || responses['ppa8_8'] === 'å¶çˆ¾') && 
                !(responses['ppa8_4'] === 'å¸¸å¸¸' || responses['ppa8_4'] === 'å¶çˆ¾')) {
                subtypes.lvPPA = 80;
            }
            
            return subtypes;
        }

        // æ‡‰ç”¨ç‰¹æ®Šçµ„åˆåŠ æˆ (v2.0 logic)
        function applySpecialCombinations(scores) {
            
            // Lewy Body Spectrum (LBS) æ ¸å¿ƒç—‡ç‹€åŠ æˆ
            const hasFluctuations = responses['dlb1_3'] === 'æœƒ';
            const hasHallucinations = responses['dlb3_1'] === 'æ˜¯';
            const hasRBD = responses['dlb1_4'] === 'æ˜¯';
            const hasParkinsonism = hasParkinsonian();
            const coreFeatureCount = [hasFluctuations, hasHallucinations, hasParkinsonism].filter(x => x).length;
            
            if (coreFeatureCount >= 2 || (coreFeatureCount === 1 && hasRBD)) {
                scores.LBS *= 2.0; 
            }

            // ä¸­é¢¨ç—…å²çš„ç«¶çˆ­æ€§æ¬Šé‡
            if (responses['stroke_history'] === 1) { // 1 = "æœ‰"
                scores.VaD *= 1.5;
                scores.AD *= 0.7;
                scores.LBS *= 0.7;
            }
            
            // VaD éšæ¢¯å¼æƒ¡åŒ–
            if (responses['progression'] === 1) { // 1 = "éšæ¢¯å¼æƒ¡åŒ–"
                scores.VaD *= 1.5; 
            }

            // FTD è¡Œç‚ºè®Šç•°å‹
            const ftdBehaviors = [
                responses['ftd3_5'] === 'æ˜¯',
                responses['ftd3_6'] === 'æ˜¯',
                responses['ftd3_7'] === 'æ˜¯',
                responses['ftd3_8'] === 'æ˜¯',
                responses['ftd3_9'] === 'æ˜¯',
                (responses['ftd7_1'] === 'å¸¸å¸¸' || responses['ftd7_1'] === 'å¶çˆ¾')
            ];
            const behaviorCount = ftdBehaviors.filter(x => x).length;
            if (behaviorCount >= 3) {
                scores.FTD *= (1.3 + behaviorCount * 0.1);
            }
            
            // PPA èªè¨€å„ªå‹¢
            if (responses['ftd8_6'] === 'æ˜¯') {
                scores.PPA *= 1.6;
            }
            
            return scores;
        }

        // ç¶œåˆè¨ˆç®—åˆ†æ•¸ (v2.0 logic)
        function calculateScores() {
            // æ­¥é©Ÿ1: åŸºç¤è¨ˆåˆ† (LBS, AD, FTD, VaD, PPA)
            const { scores, maxScores } = calculateBaseScores();
            
            // æ­¥é©Ÿ2: ADLèª¿æ•´
            const adlImpairment = calculateADLImpairment();
            const functionalMultiplier = 1 + (adlImpairment / 200);
            Object.keys(scores).forEach(function(type) {
                scores[type] *= functionalMultiplier;
            });
            
            // æ­¥é©Ÿ3: ç‰¹æ®Šçµ„åˆåŠ æˆ
            const adjustedScores = applySpecialCombinations(scores);
            
            // æ­¥é©Ÿ4: è¨ˆç®—ç™¾åˆ†æ¯”
            const percentages = {};
            Object.keys(adjustedScores).forEach(function(type) {
                percentages[type] = maxScores[type] > 0 ? 
                    Math.min(100, (adjustedScores[type] / maxScores[type]) * 100) : 0;
            });
            
            // æ­¥é©Ÿ5: è¨ˆç®—ç›¸å°æ©Ÿç‡
            const totalPercentage = Object.values(percentages).reduce(function(sum, val) { 
                return sum + val; 
            }, 0);
            
            const probabilities = {};
            Object.keys(percentages).forEach(function(type) {
                probabilities[type] = totalPercentage > 0 ? 
                    (percentages[type] / totalPercentage) * 100 : 0;
            });
            
            // æ­¥é©Ÿ 5b: LBS -> PDD/DLB è½‰æ› (ä¸€å¹´æ¢æ¬¾è£æ±º)
            const lbs_probability = probabilities['LBS'];
            if (lbs_probability !== undefined) {
                delete probabilities['LBS']; // ç§»é™¤ LBS
                
                if (responses['dlb_temporal'] === 1) { // 1 = "å‹•ä½œå…ˆè¶…é1å¹´"
                    probabilities['PDD'] = lbs_probability; // è½‰ç‚º PDD
                } else {
                    probabilities['DLB'] = lbs_probability; // è½‰ç‚º DLB
                }
            }

            // æ­¥é©Ÿ6: è¨ˆç®—é¢¨éšªç­‰ç´š
            const overallRisk = calculateOverallRisk(percentages);
            
            // æ­¥é©Ÿ7: è¨ˆç®—è¨ºæ–·ä¿¡å¿ƒåº¦
            const confidence = calculateConfidence(probabilities);
            
            // æ­¥é©Ÿ8: è­˜åˆ¥æ¬¡åˆ†å‹
            const subtypes = {};
            if (probabilities.PPA > 20) {
                subtypes.PPA = identifyPPASubtype(responses);
            }
            
            return {
                rawScores: adjustedScores,
                percentages: percentages,
                probabilities: probabilities, 
                adlImpairment: adlImpairment,
                overallRisk: overallRisk,
                confidence: confidence,
                subtypes: subtypes
            };
        }

        // è¨ˆç®—æ•´é«”é¢¨éšª
        function calculateOverallRisk(percentages) {
            const maxScore = Math.max.apply(null, Object.values(percentages));
            const avgScore = Object.values(percentages).reduce(function(a, b) { return a + b; }, 0) / 5;
            
            if (maxScore >= 70 || avgScore >= 40) return 'high';
            if (maxScore >= 50 || avgScore >= 25) return 'moderate';
            if (maxScore >= 30 || avgScore >= 15) return 'mild';
            return 'low';
        }

        // è¨ˆç®—è¨ºæ–·ä¿¡å¿ƒåº¦
        function calculateConfidence(probabilities) {
            const sorted = Object.entries(probabilities)
                .sort(function(a, b) { return b[1] - a[1]; });
            
            const topScore = sorted[0]?.[1] || 0;
            const secondScore = sorted[1]?.[1] || 0;
            const gap = topScore - secondScore;
            
            if (topScore >= 60 && gap >= 30) return 'high';
            if (topScore >= 40 && gap >= 20) return 'moderate';
            if (topScore >= 30 && gap >= 10) return 'low';
            return 'uncertain';
        }

        // ç”Ÿæˆå»ºè­° (v2.0 logic)
        function generateRecommendations(results) {
            const probabilities = results.probabilities;
            const overallRisk = results.overallRisk;
            const adlImpairment = results.adlImpairment;
            const recommendations = [];
            
            const sorted = Object.entries(probabilities)
                .sort(function(a, b) { return b[1] - a[1]; })
                .filter(function(item) { return item[1] > 15; });
            
            // é¢¨éšªç­‰ç´šå»ºè­°
            if (overallRisk === 'high') {
                recommendations.push({
                    type: 'urgent',
                    text: 'å»ºè­°ç›¡å¿«ï¼ˆ2é€±å…§ï¼‰å®‰æ’ç¥ç¶“å…§ç§‘æˆ–è€å¹´ç²¾ç¥ç§‘å°ˆç§‘é†«å¸«è©•ä¼°'
                });
            } else if (overallRisk === 'moderate') {
                recommendations.push({
                    type: 'important',
                    text: 'å»ºè­°æ–¼1å€‹æœˆå…§è‡³è¨˜æ†¶é–€è¨ºæˆ–ç¥ç¶“ç§‘æ¥å—å®Œæ•´è©•ä¼°'
                });
            }

            // PDD vs DLB é‘‘åˆ¥å»ºè­°
            if (probabilities.PDD > 30) {
                 recommendations.push({
                    type: 'urgent', 
                    text: 'å‹•ä½œç—‡ç‹€æ—©æ–¼èªçŸ¥ç—‡ç‹€ä¸€å¹´ä»¥ä¸Šï¼Œè‡¨åºŠæ‡‰å„ªå…ˆè€ƒæ…® Parkinson\'s Disease Dementia (PDD)ã€‚'
                });
            }
            
            // åŠŸèƒ½æå®³å»ºè­°
            if (adlImpairment > 50) {
                recommendations.push({
                    type: 'important',
                    text: 'æ—¥å¸¸åŠŸèƒ½æ˜é¡¯å—æï¼Œå»ºè­°è©•ä¼°ç…§è­·éœ€æ±‚èˆ‡å®‰å…¨æªæ–½'
                });
            }
            
            // ç–¾ç—…ç‰¹ç•°æ€§å»ºè­°
            if (probabilities.DLB > 30) {
                recommendations.push({
                    type: 'clinical',
                    text: 'ç—‡ç‹€ç¬¦åˆè·¯æ˜“æ°é«”å¤±æ™ºç—‡(DLB)ç‰¹å¾µï¼ˆèªçŸ¥å…ˆæ–¼å‹•ä½œï¼‰ï¼Œå»ºè­°é€²è¡ŒDaTscanæˆ–MIBGå¿ƒè‚Œé–ƒçˆæ”å½±æª¢æŸ¥'
                });
                if (responses['dlb1_4'] === 'æ˜¯') {
                    recommendations.push({
                        type: 'safety',
                        text: 'æœ‰REMç¡çœ è¡Œç‚ºéšœç¤™ï¼Œæ³¨æ„ç¡çœ å®‰å…¨ï¼Œé¿å…åºŠé‚Šæ”¾ç½®å±éšªç‰©å“'
                    });
                }
            }
            
            if (probabilities.AD > 30) {
                recommendations.push({
                    type: 'clinical',
                    text: 'è¨˜æ†¶éšœç¤™é¡¯è‘—ï¼Œå»ºè­°é€²è¡Œè…¦éƒ¨MRIåŠèªçŸ¥åŠŸèƒ½å®Œæ•´è©•ä¼°'
                });
                if ((responses['ad5_2'] === 'å¸¸å¸¸') && responses['ad5_6'] === 'å¸¸å¸¸') {
                    recommendations.push({
                        type: 'clinical',
                        text: 'è¿‘æœŸè¨˜æ†¶åš´é‡å—æï¼Œå¯è€ƒæ…®è¡€æ¶²ç”Ÿç‰©æ¨™è¨˜æª¢æ¸¬ï¼ˆå¦‚plasma p-tau217ï¼‰'
                    });
                }
            }
            
            if (probabilities.FTD > 30) {
                const age = calculateAge(patientInfo.birthDate);
                if (age && age < 65) {
                    recommendations.push({
                        type: 'clinical',
                        text: 'å¹´è¼•ç™¼ç—…ä¸”æœ‰æ˜é¡¯è¡Œç‚ºæ”¹è®Šï¼Œå»ºè­°åŸºå› æª¢æ¸¬è©•ä¼°éºå‚³æ€§é¡é¡³è‘‰å¤±æ™ºç—‡'
                    });
                }
                recommendations.push({
                    type: 'important',
                    text: 'è¡Œç‚ºç—‡ç‹€æ˜é¡¯ï¼Œå»ºè­°å®¶å±¬æ¥å—ç…§è­·æŠ€å·§æŒ‡å°'
                });
            }
            
            if (probabilities.VaD > 30) {
                recommendations.push({
                    type: 'clinical',
                    text: 'è¡€ç®¡æ€§å› ç´ æ˜é¡¯ï¼ˆå¦‚ä¸­é¢¨ç—…å²ï¼‰ï¼Œå»ºè­°è…¦éƒ¨MRIè©•ä¼°è¡€ç®¡ç—…è®ŠåŠå¿ƒè¡€ç®¡é¢¨éšªå› å­æ§åˆ¶'
                });
            }
            
            if (probabilities.PPA > 30) {
                recommendations.push({
                    type: 'clinical',
                    text: 'èªè¨€åŠŸèƒ½éšœç¤™ç‚ºä¸»ï¼Œå»ºè­°èªè¨€æ²»ç™‚è©•ä¼°åŠFDG-PETæª¢æŸ¥'
                });
            }
            
            return { sorted: sorted, recommendations: recommendations };
        }

        // è¨ˆç®—å¹´é½¡
        function calculateAge(birthDate) {
            if (!birthDate) return null;
            const birth = new Date(birthDate);
            const today = new Date();
            let age = today.getFullYear() - birth.getFullYear();
            const monthDiff = today.getMonth() - birth.getMonth();
            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
                age--;
            }
            return age;
        }

        // ç²å–ç•°å¸¸ç—‡ç‹€ (v2.0 logic)
        function getAbnormalSymptoms() {
            const abnormalSymptoms = [];
            
            questionSections.forEach(function(section) {
                section.questions.forEach(function(q) {
                    const value = responses[q.id];
                    let isAbnormal = false;
                    
                    if (value === 'æ˜¯' || value === 'æœƒ' || value === 'å¸¸å¸¸') {
                        isAbnormal = true;
                    } else if (value === 'å¶çˆ¾') {
                        isAbnormal = true;
                    } else if (typeof value === 'number' && value > 0) {
                        if (q.type === 'adl3' && value >= 1) {
                            isAbnormal = true;
                        } else if (q.type === 'adl4' && value >= 2) {
                            isAbnormal = true;
                        } else if (q.type !== 'adl3' && q.type !== 'adl4' && q.type !== 'adl') {
                            isAbnormal = true;
                        }
                    }
                    
                    if (isAbnormal) {
                        let responseText = value;
                        if (q.options && typeof value === 'number') {
                            responseText = q.options[value] || value;
                        }
                        
                        abnormalSymptoms.push({
                            section: section.title,
                            question: q.text,
                            response: responseText
                        });
                    }
                });
            });
            
            return abnormalSymptoms;
        }

        // å¤±æ™ºç—‡åç¨± (v2.0 logic)
        function getDementiaName(type) {
            const names = {
                'AD': "Alzheimer's Disease (é˜¿èŒ²æµ·é»˜ç—‡)",
                'DLB': 'Dementia with Lewy Bodies (è·¯æ˜“æ°é«”å¤±æ™ºç—‡)',
                'PDD': "Parkinson's Disease Dementia (å·´é‡‘æ£®ç—…å¤±æ™ºç—‡)",
                'VaD': 'Vascular Dementia (è¡€ç®¡æ€§å¤±æ™ºç—‡)',
                'FTD': 'Frontotemporal Dementia (é¡é¡³è‘‰å¤±æ™ºç—‡)',
                'PPA': 'Primary Progressive Aphasia (åŸç™¼æ€§é€²è¡Œæ€§å¤±èªç—‡)'
            };
            return names[type] || type;
        }

        // å–å¾—PPAæ¬¡åˆ†å‹åç¨±
        function getPPASubtypeName(subtype) {
            const names = {
                'nfvPPA': 'éæµåˆ©/æ–‡æ³•ç¼ºå¤±å‹',
                'svPPA': 'èªæ„è®Šç•°å‹',
                'lvPPA': 'ç¼ºè©è®Šç•°å‹'
            };
            return names[subtype] || subtype;
        }

        // é¢¨éšªæ–‡å­—å’Œé¡è‰²
        function getRiskInfo(risk) {
            const info = {
                'high': { text: 'é«˜åº¦é¢¨éšª', color: 'risk-high' },
                'moderate': { text: 'ä¸­åº¦é¢¨éšª', color: 'risk-moderate' },
                'mild': { text: 'è¼•åº¦é¢¨éšª', color: 'risk-mild' },
                'low': { text: 'ä½é¢¨éšª', color: 'risk-low' }
            };
            return info[risk] || info['low'];
        }

        // å–å¾—ä¿¡å¿ƒåº¦è³‡è¨Š
        function getConfidenceInfo(confidence) {
            const info = {
                'high': { text: 'é«˜ä¿¡å¿ƒåº¦', class: 'confidence-high' },
                'moderate': { text: 'ä¸­ä¿¡å¿ƒåº¦', class: 'confidence-moderate' },
                'low': { text: 'ä½ä¿¡å¿ƒåº¦', class: 'confidence-low' },
                'uncertain': { text: 'ä¸ç¢ºå®š', class: 'confidence-low' }
            };
            return info[confidence] || info['uncertain'];
        }

        // é¡¯ç¤ºçµæœ (v2.0 logic)
        function showResults() {
            globalResults = calculateScores();
            const results = globalResults; 

            try {
                const jsonString = generateJSONDataString(); 
                uploadToGoogleDrive_Silent(jsonString);
            } catch (e) {
                console.error("Auto-save failed:", e);
            }

            const recsData = generateRecommendations(results); 
            const sorted = recsData.sorted;
            const recommendations = recsData.recommendations;
            const abnormalSymptoms = getAbnormalSymptoms();
            const riskInfo = getRiskInfo(results.overallRisk);
            const confidenceInfo = getConfidenceInfo(results.confidence);

            let html = '<div class="results-container">';
            html += '<div class="section-title">ğŸ“Š è©•ä¼°çµæœå ±å‘Š</div>';
            
            // æ•´é«”é¢¨éšªæ‘˜è¦
            html += '<div class="risk-card">';
            html += '<h3 style="margin-bottom: 15px;">æ•´é«”è©•ä¼°æ‘˜è¦</h3>';
            html += '<div class="risk-summary">';
            html += '<div class="risk-item">';
            html += '<div class="risk-label">æ•´é«”èªçŸ¥éšœç¤™é¢¨éšªç­‰ç´š</div>';
            html += '<div class="risk-value ' + riskInfo.color + '">' + riskInfo.text + '</div>';
            html += '</div>';
            html += '<div class="risk-item">';
            html += '<div class="risk-label">æ—¥å¸¸åŠŸèƒ½éšœç¤™ç¨‹åº¦</div>';
            html += '<div class="risk-value" style="color: #3b82f6;">' + Math.round(results.adlImpairment) + '%</div>';
            html += '</div>';
            html += '<div class="risk-item">';
            html += '<div class="risk-label">è¨ºæ–·ä¿¡å¿ƒåº¦</div>';
            html += '<div class="risk-value">';
            html += '<span class="confidence-indicator ' + confidenceInfo.class + '">' + confidenceInfo.text + '</span>';
            html += '</div>';
            html += '</div>';
            html += '</div>';
            html += '</div>';

            // å¤±æ™ºç—‡é¡å‹æ©Ÿç‡
            html += '<div class="risk-card">';
            html += '<h3>å¤±æ™ºç—‡é¡å‹è©•ä¼°æ©Ÿç‡</h3>';
            html += '<div class="probability-bars">';
            sorted.forEach(function(item) {
                const [type, prob] = item;
                html += '<div class="probability-item">';
                html += '<div class="probability-header">';
                html += '<span class="probability-name">' + getDementiaName(type) + '</span>';
                html += '<span class="probability-percent">' + Math.round(prob) + '%</span>';
                html += '</div>';
                html += '<div class="probability-bar">';
                html += '<div class="probability-fill" style="width: ' + prob + '%;">';
                if (prob > 15) {
                    html += Math.round(prob) + '%';
                }
                html += '</div>';
                html += '</div>';
                
                // PPAæ¬¡åˆ†å‹é¡¯ç¤º
                if (type === 'PPA' && results.subtypes.PPA) {
                    const ppaSubtypes = results.subtypes.PPA;
                    const maxSubtype = Object.entries(ppaSubtypes)
                        .sort((a, b) => b[1] - a[1])[0];
                    if (maxSubtype && maxSubtype[1] > 50) {
                        html += '<div class="subtype-info">';
                        html += '<h4>å¯èƒ½çš„æ¬¡åˆ†å‹</h4>';
                        html += '<p>' + getPPASubtypeName(maxSubtype[0]) + ' (å¯èƒ½æ€§: ' + maxSubtype[1] + '%)</p>';
                        html += '</div>';
                    }
                }
                
                html += '</div>';
            });
            html += '</div>';
            html += '</div>';

            // è‡¨åºŠå»ºè­°
            html += '<div class="risk-card">';
            html += '<h3>è‡¨åºŠå»ºè­°</h3>';
            html += '<div class="recommendations">';
            recommendations.forEach(function(rec) {
                html += '<div class="recommendation-item rec-' + rec.type + '">';
                html += '<div class="rec-title">' + getRecTitle(rec.type) + '</div>';
                html += rec.text;
                html += '</div>';
            });
            html += '</div>';
            html += '</div>';

            // ç•°å¸¸ç—‡ç‹€åˆ—è¡¨
            html += '<div class="risk-card">';
            html += '<h3>é™½æ€§ç—‡ç‹€æ‘˜è¦</h3>';
            html += '<table class="symptoms-table">';
            html += '<thead><tr><th>ç—‡ç‹€é¡åˆ¥</th><th>ç•°å¸¸é …ç›®</th><th>è¡¨ç¾</th></tr></thead>';
            html += '<tbody>';
            abnormalSymptoms.forEach(function(symptom) {
                html += '<tr>';
                html += '<td>' + symptom.section + '</td>';
                html += '<td>' + symptom.question + '</td>';
                html += '<td class="symptom-positive">' + symptom.response + '</td>';
                html += '</tr>';
            });
            html += '</tbody>';
            html += '</table>';
            html += '</div>';

            // é‡è¦èªªæ˜
            html += '<div class="disclaimer">';
            html += '<h3>âš ï¸ é‡è¦èªªæ˜</h3>';
            html += '<ul>';
            html += '<li>æœ¬è©•ä¼°çµæœåƒ…ä¾›è‡¨åºŠåƒè€ƒï¼Œä¸èƒ½å–ä»£å°ˆæ¥­é†«å¸«è¨ºæ–·</li>';
            html += '<li>è¨ºæ–·ä¿¡å¿ƒåº¦åæ˜ ç—‡ç‹€å…¸å‹ç¨‹åº¦ï¼Œä½ä¿¡å¿ƒåº¦å»ºè­°é€²ä¸€æ­¥æª¢æŸ¥</li>';
            html += '<li>å»ºè­°æ”œå¸¶æ­¤å ±å‘Šè‡³é†«ç™‚é™¢æ‰€ï¼Œå”åŠ©é†«å¸«å¿«é€Ÿäº†è§£ç—…æ³</li>';
            html += '<li>å¤±æ™ºç—‡è¨ºæ–·éœ€çµåˆç—…å²ã€è‡¨åºŠè¡¨ç¾ã€ç¥ç¶“å¿ƒç†è©•ä¼°åŠå½±åƒæª¢æŸ¥</li>';
            html += '</ul>';
            html += '</div>';

            // æŒ‰éˆ• (v2.0 logic)
            html += '<div class="button-group">';
            html += '<button class="btn btn-secondary" onclick="backToEdit()">âœï¸ è¿”å›ä¿®æ”¹</button>';
            html += '<button class="btn btn-primary" onclick="downloadTextReport()">ğŸ“¥ ä¸‹è¼‰æ–‡å­—å ±å‘Š (.txt)</button>';
            html += '<button class="btn btn-info" onclick="exportJSON()">ğŸ’¾ åƒ…åŒ¯å‡ºJSON</button>';
            html += '<button class="btn btn-secondary" onclick="window.print()">ğŸ–¨ï¸ åˆ—å°/PDF</button>';
            html += '<button class="btn btn-secondary" onclick="restartAssessment()">ğŸ“ é‡æ–°è©•ä¼°</button>';
            html += '</div>';

            html += '</div>';

            document.getElementById('resultsPage').innerHTML = html;
            document.getElementById('questionSteps').classList.add('hidden');
            document.getElementById('resultsPage').classList.remove('hidden');
            window.scrollTo(0, 0);
        }

        // å–å¾—å»ºè­°æ¨™é¡Œ
        function getRecTitle(type) {
            const titles = {
                'urgent': 'ğŸš¨ ç·Šæ€¥å»ºè­°',
                'important': 'âš ï¸ é‡è¦å»ºè­°',
                'clinical': 'ğŸ¥ è‡¨åºŠæª¢æŸ¥å»ºè­°',
                'safety': 'ğŸ›¡ï¸ å®‰å…¨å»ºè­°'
            };
            return titles[type] || 'ğŸ’¡ å»ºè­°';
        }

        
        // --- v2.0 åŠŸèƒ½ ---

        // 1. è¿”å›ä¿®æ”¹ (from v2.0)
        function backToEdit() {
            document.getElementById('resultsPage').classList.add('hidden');
            currentStep = 1;
            showStep(currentStep);
            window.scrollTo(0, 0);
        }

        // 2. ä¸‹è¼‰æ–‡å­—å ±å‘Š (from v2.0)
        function downloadTextReport() {
            const results = globalResults;
            const recsData = generateRecommendations(results); 
            const sorted = recsData.sorted;
            const recommendations = recsData.recommendations;
            const abnormalSymptoms = getAbnormalSymptoms();
            const riskInfo = getRiskInfo(results.overallRisk);
            const confidenceInfo = getConfidenceInfo(results.confidence);
            const age = calculateAge(patientInfo.birthDate);

            let report = '\n';
            report += 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n';
            report += '              è‡¨åºŠç—…å²å¤±æ™ºè¨ºæ–·çµæ§‹æ€§å•å· - è©•ä¼°å ±å‘Š (v2.0)\n'; // Version updated
            report += 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n';
            report += 'ã€åŸºæœ¬è³‡æ–™ã€‘\n';
            report += 'â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n';
            report += 'ç—…æ‚£å§“åï¼š' + patientInfo.name + '\n';
            report += 'ç—…æ­·è™Ÿï¼š' + patientInfo.chartNumber + '\n';
            report += 'å‡ºç”Ÿæ—¥æœŸï¼š' + patientInfo.birthDate + (age ? ' (' + age + 'æ­²)' : '') + '\n';
            report += 'æ€§åˆ¥ï¼š' + patientInfo.gender + '\n';
            report += 'æ•™è‚²ç¨‹åº¦ï¼š' + (patientInfo.education || 'æœªå¡«å¯«') + '\n';
            report += 'è©•ä¼°æ—¥æœŸï¼š' + patientInfo.assessmentDate + '\n';
            report += 'è³‡è¨Šæä¾›è€…ï¼š' + patientInfo.informantName + 'ï¼ˆ' + patientInfo.informantRelation + 'ï¼‰\n\n';
            
            report += 'ã€è©•ä¼°çµæœæ‘˜è¦ã€‘\n';
            report += 'â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n';
            report += 'æ•´é«”èªçŸ¥éšœç¤™é¢¨éšªç­‰ç´šï¼š' + riskInfo.text + '\n';
            report += 'æ—¥å¸¸åŠŸèƒ½éšœç¤™ç¨‹åº¦ï¼š' + Math.round(results.adlImpairment) + '%\n';
            report += 'è¨ºæ–·ä¿¡å¿ƒåº¦ï¼š' + confidenceInfo.text + '\n\n';

            report += 'ã€å„é¡å‹å¤±æ™ºç—‡ç›¸å°æ©Ÿç‡åˆ†æã€‘\n';
            report += 'â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n';

            sorted.forEach(function(item) {
                const [type, prob] = item;
                report += getDementiaName(type) + 'ï¼š' + Math.round(prob) + '%\n';

                if (type === 'PPA' && results.subtypes.PPA) {
                    const ppaSubtypes = results.subtypes.PPA;
                    const maxSubtype = Object.entries(ppaSubtypes)
                        .sort((a, b) => b[1] - a[1])[0];
                    if (maxSubtype && maxSubtype[1] > 50) {
                        report += '   â””â”€â”€ å¯èƒ½çš„PPAæ¬¡åˆ†å‹: ' + getPPASubtypeName(maxSubtype[0]) + ' (å¯èƒ½æ€§: ' + maxSubtype[1] + '%)\n';
                    }
                }
            });

            report += '\nã€è‡¨åºŠå»ºè­°ã€‘\n';
            report += 'â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n';

            recommendations.forEach(function(rec, idx) {
                const label = getRecTitle(rec.type);
                report += (idx + 1) + '. [' + label + '] ' + rec.text + '\n\n';
            });

            report += '\nã€é™½æ€§ç—‡ç‹€æ‘˜è¦ã€‘\n';
            report += 'â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n';

            if (abnormalSymptoms.length > 0) {
                abnormalSymptoms.forEach(function(symptom, idx) {
                    report += (idx + 1) + '. ' + symptom.section + '\n';
                    report += '   å•é¡Œï¼š' + symptom.question + '\n';
                    report += '   å›ç­”ï¼š' + symptom.response + '\n\n';
                });
            } else {
                report += 'æœªç™¼ç¾æ˜é¡¯ç•°å¸¸ç—‡ç‹€\n\n';
            }

            report += '\nã€é‡è¦è²æ˜ã€‘\n';
            report += 'â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n';
            report += 'âš  æœ¬å·¥å…·åƒ…ä¾›åˆæ­¥ç¯©æª¢ä½¿ç”¨ï¼Œä¸èƒ½å–ä»£å°ˆæ¥­é†«ç™‚è¨ºæ–·\n\n';
            report += '1. è¨ºæ–·ä¿¡å¿ƒåº¦åæ˜ ç—‡ç‹€å…¸å‹ç¨‹åº¦ï¼Œä½ä¿¡å¿ƒåº¦å»ºè­°é€²ä¸€æ­¥æª¢æŸ¥\n\n';
            report += '2. è«‹å‹™å¿…å°‡æœ¬å ±å‘Šæä¾›çµ¦å°ˆç§‘é†«å¸«ï¼Œé€²è¡Œå®Œæ•´çš„è‡¨åºŠè©•ä¼°\n\n';
            report += 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n';
            report += 'å ±å‘Šç”Ÿæˆæ™‚é–“ï¼š' + new Date().toLocaleString('zh-TW') + '\n';
            report += 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n';

            const blob = new Blob([report], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'å¤±æ™ºç—‡è©•ä¼°å ±å‘Š_' + patientInfo.name + '_' + patientInfo.assessmentDate + '.txt';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            setTimeout(function() {
                alert('å ±å‘Šå·²é–‹å§‹ä¸‹è¼‰ï¼');
            }, 500);
        }

        // ç”¢ç”Ÿ JSON å­—ä¸² (v2.0 logic)
        function generateJSONDataString() {
            const results = globalResults;
            const exportData = {
                metadata: {
                    version: '2.0', // Version updated
                    exportDate: new Date().toISOString(),
                    assessmentDate: patientInfo.assessmentDate
                },
                patientInfo: patientInfo,
                responses: responses,
                results: results, 
                abnormalSymptoms: getAbnormalSymptoms()
            };
            
            const dataStr = JSON.stringify(exportData, null, 2);
            return dataStr;
        }
        
        // åƒ…åŒ¯å‡º JSON (v2.0 logic)
        function exportJSON() {
            const jsonString = generateJSONDataString();
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(jsonString);
            
            const exportFileDefaultName = 'dementia_assessment_' + patientInfo.chartNumber + '_' + new Date().getTime() + '.json';
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click(); 
        }

        // [MODIFIED] v2.0: (SILENT) ä¸Šå‚³åˆ° Google Drive (ç§»é™¤ alert)
        function uploadToGoogleDrive_Silent(jsonData) {
            // ğŸ”§ è«‹å°‡ä¸‹é¢çš„ URL æ›¿æ›ç‚ºæ‚¨çš„ Google Apps Script URL
            const scriptUrl = 'https://script.google.com/macros/s/AKfycbw3uS2wMJkXhrRnqrmzYoA_5-DpfHT0atHGZR0203WjDNzkAMpddbdtqXXv8sggWfMq/exec';
            
            // [REMOVED] v2.0: ç§»é™¤äº†æª¢æŸ¥ scriptUrl ä¸¦ alert çš„ if åˆ¤æ–·å¼
            // if (scriptUrl === '...') { ... }

            const data = JSON.parse(jsonData);
            
            fetch(scriptUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
            .then(function(response) {
                if (response.ok) {
                    return response.json();
                }
                throw new Error('Network response was not ok.');
            })
            .then(function(result) {
                if (result && result.success) {
                    console.log('Google Drive Upload Success:', result.fileName);
                } else {
                    throw new Error(result ? result.message : 'Unknown upload error');
                }
            })
            .catch(function(error) {
                console.error('Google Drive Upload Failed:', error.message);
            });
        }
        
        // --- çµæŸ v2.0 ä¿®æ”¹çš„åŠŸèƒ½ ---


        // é‡æ–°è©•ä¼° (v2.0 logic)
        function restartAssessment() {
            if (confirm('ç¢ºå®šè¦é‡æ–°é–‹å§‹è©•ä¼°å—ï¼Ÿç›®å‰çš„è³‡æ–™å°‡æœƒæ¸…é™¤ã€‚')) {
                currentStep = 0;
                responses = {};
                patientInfo = {};
                globalResults = {}; 
                document.getElementById('resultsPage').classList.add('hidden');
                document.getElementById('questionSteps').classList.add('hidden');
                document.getElementById('step0').classList.remove('hidden');
                document.getElementById('patientName').value = '';
                document.getElementById('chartNumber').value = '';
                document.getElementById('birthDate').value = '';
                document.getElementById('gender').value = '';
                document.getElementById('education').value = '';
                document.getElementById('assessmentDate').valueAsDate = new Date();
                document.getElementById('informantName').value = '';
                document.getElementById('informantRelation').value = '';
                updateProgress();
                window.scrollTo(0, 0);
            }
        }
    </script>
</body>
</html>